(()=>{var le={start:"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",empty:"8/8/8/8/8/8/8/8"},L=class h{constructor(e=le.empty){this.squares=new Array(64).fill(null),this.setFen(e)}setFen(e=le.empty){let t=e.replace(/^\s*/,"").replace(/\s*$/,"").split(/\/|\s/);for(let s=0;s<8;s++){let i=t[7-s].replace(/\d/g,r=>{let o=parseInt(r),n="";for(let d=0;d<o;d++)n+="-";return n});for(let r=0;r<8;r++){let o=i.substring(r,r+1),n=null;o!=="-"&&(o.toUpperCase()===o?n=`w${o.toLowerCase()}`:n=`b${o}`),this.squares[s*8+r]=n}}}getFen(){let e=new Array(8).fill("");for(let t=0;t<8;t++){let s=0;for(let i=0;i<8;i++){let r=this.squares[t*8+i];if(!r)s++;else{s>0&&(e[7-t]+=s,s=0);let o=r.substring(0,1),n=r.substring(1,2);o==="w"?e[7-t]+=n.toUpperCase():e[7-t]+=n}}s>0&&(e[7-t]+=s,s=0)}return e.join("/")}getPieces(e=void 0,t=void 0,s=["k","q","r","b","n","p"]){let i=[],r=(o,n)=>s.indexOf(o.name)-s.indexOf(n.name);for(let o=0;o<64;o++){let n=this.squares[o];if(n){let d=n.charAt(1),p=n.charAt(0),g=h.indexToSquare(o);if(t&&t!==d||e&&e!==p)continue;i.push({name:d,type:d,color:p,position:g,square:g})}}return s&&i.sort(r),i}movePiece(e,t){if(!this.squares[h.squareToIndex(e)]){console.warn("no piece on",e);return}this.squares[h.squareToIndex(t)]=this.squares[h.squareToIndex(e)],this.squares[h.squareToIndex(e)]=null}setPiece(e,t){this.squares[h.squareToIndex(e)]=t}getPiece(e){return this.squares[h.squareToIndex(e)]}static squareToIndex(e){let t=h.squareToCoordinates(e);return t[0]+t[1]*8}static indexToSquare(e){return this.coordinatesToSquare([Math.floor(e%8),e/8])}static squareToCoordinates(e){let t=e.charCodeAt(0)-97,s=e.charCodeAt(1)-49;return[t,s]}static coordinatesToSquare(e){let t=String.fromCharCode(e[0]+97),s=String.fromCharCode(e[1]+49);return t+s}toString(){return this.getFen()}clone(){let e=new h;return e.squares=this.squares.slice(0),e}};var Te=class{constructor(){this.position=new L,this.orientation=void 0,this.inputWhiteEnabled=!1,this.inputBlackEnabled=!1,this.squareSelectEnabled=!1,this.moveInputCallback=null,this.extensionPoints={},this.moveInputProcess=Promise.resolve()}inputEnabled(){return this.inputWhiteEnabled||this.inputBlackEnabled}invokeExtensionPoints(e,t={}){let s=this.extensionPoints[e],i=Object.assign({},t);i.extensionPoint=e;let r=!0;if(s)for(let o of s)o(i)===!1&&(r=!1);return r}};var Pt="http://www.w3.org/2000/svg",k=class{static createSvg(e=void 0){let t=document.createElementNS(Pt,"svg");return e&&(t.setAttribute("width","100%"),t.setAttribute("height","100%"),e.appendChild(t)),t}static addElement(e,t,s={}){let i=document.createElementNS(Pt,t);t==="use"&&(s["xlink:href"]=s.href);for(let r in s)if(s.hasOwnProperty(r))if(r.indexOf(":")!==-1){let o=r.split(":");i.setAttributeNS("http://www.w3.org/1999/"+o[0],o[1],s[r])}else i.setAttribute(r,s[r]);return e.appendChild(i),i}static removeElement(e){if(!e){console.warn("removeElement, element is",e);return}e.parentNode?e.parentNode.removeChild(e):console.warn(e,"without parentNode")}};var x={positionChanged:"positionChanged",boardChanged:"boardChanged",moveInputToggled:"moveInputToggled",moveInput:"moveInput",beforeRedrawBoard:"beforeRedrawBoard",afterRedrawBoard:"afterRedrawBoard",redrawBoard:"redrawBoard",animation:"animation",destroy:"destroy"},Q=class{constructor(e){this.chessboard=e}registerExtensionPoint(e,t){e===x.redrawBoard&&(console.warn("EXTENSION_POINT.redrawBoard is deprecated, use EXTENSION_POINT.afterRedrawBoard"),e=x.afterRedrawBoard),this.chessboard.state.extensionPoints[e]||(this.chessboard.state.extensionPoints[e]=[]),this.chessboard.state.extensionPoints[e].push(t)}registerMethod(e,t){console.warn("registerMethod is deprecated, just add methods directly to the chessboard instance"),this.chessboard[e]?log.error("method",e,"already exists"):this.chessboard[e]=(...s)=>t.apply(this,s)}};var D=class h{static delegate(e,t,s,i){let r=function(o){let n=o.target;for(;n&&n!==this;)n.matches(s)&&i.call(n,o),n=n.parentNode};return e.addEventListener(t,r),{remove:function(){e.removeEventListener(t,r)}}}static mergeObjects(e,t){let s=i=>i&&typeof i=="object";if(!s(e)||!s(t))return t;for(let i of Object.keys(t))t[i]instanceof Object&&Object.assign(t[i],h.mergeObjects(e[i],t[i]));return Object.assign(e||{},t),e}static createDomElement(e){let t=document.createElement("template");return t.innerHTML=e.trim(),t.content.firstChild}static createTask(){let e,t,s=new Promise(function(i,r){e=i,t=r});return s.resolve=e,s.reject=t,s}static isAbsoluteUrl(e){return e.indexOf("://")!==-1||e.startsWith("/")}};var Ve={start:"start",frame:"frame",end:"end"},We=class{constructor(){this.queue=[],this.workingOnPromise=!1,this.stop=!1}async enqueue(e){return new Promise((t,s)=>{this.queue.push({promise:e,resolve:t,reject:s}),this.dequeue()})}dequeue(){if(this.workingOnPromise)return;if(this.stop){this.queue=[],this.stop=!1;return}let e=this.queue.shift();if(e){try{this.workingOnPromise=!0,e.promise().then(t=>{this.workingOnPromise=!1,e.resolve(t),this.dequeue()}).catch(t=>{this.workingOnPromise=!1,e.reject(t),this.dequeue()})}catch(t){this.workingOnPromise=!1,e.reject(t),this.dequeue()}return!0}}destroy(){this.stop=!0}},Y={move:0,appear:1,disappear:2},ve=class h{constructor(e,t,s,i,r){this.view=e,t&&s?(this.animatedElements=this.createAnimation(t.squares,s.squares),this.duration=i,this.callback=r,this.frameHandle=requestAnimationFrame(this.animationStep.bind(this))):console.error("fromPosition",t,"toPosition",s),this.view.positionsAnimationTask=D.createTask(),this.view.chessboard.state.invokeExtensionPoints(x.animation,{type:Ve.start})}static seekChanges(e,t){let s=[],i=[],r=[];for(let o=0;o<64;o++){let n=e[o],d=t[o];d!==n&&(d&&s.push({piece:d,index:o}),n&&i.push({piece:n,index:o}))}return s.forEach(o=>{let n=8,d=null;i.forEach(p=>{if(o.piece===p.piece){let g=h.squareDistance(o.index,p.index);g<n&&(d=p,n=g)}}),d?(i.splice(i.indexOf(d),1),r.push({type:Y.move,piece:o.piece,atIndex:d.index,toIndex:o.index})):r.push({type:Y.appear,piece:o.piece,atIndex:o.index})}),i.forEach(o=>{r.push({type:Y.disappear,piece:o.piece,atIndex:o.index})}),r}createAnimation(e,t){let s=h.seekChanges(e,t),i=[];return s.forEach(r=>{let o={type:r.type};switch(r.type){case Y.move:o.element=this.view.getPieceElement(L.indexToSquare(r.atIndex)),o.element.parentNode.appendChild(o.element),o.atPoint=this.view.indexToPoint(r.atIndex),o.toPoint=this.view.indexToPoint(r.toIndex);break;case Y.appear:o.element=this.view.drawPieceOnSquare(L.indexToSquare(r.atIndex),r.piece),o.element.style.opacity=0;break;case Y.disappear:o.element=this.view.getPieceElement(L.indexToSquare(r.atIndex));break}i.push(o)}),i}animationStep(e){if(!this.view||!this.view.chessboard.state)return;this.startTime||(this.startTime=e);let t=e-this.startTime;if(t<=this.duration)this.frameHandle=requestAnimationFrame(this.animationStep.bind(this));else{cancelAnimationFrame(this.frameHandle),this.animatedElements.forEach(r=>{r.type===Y.disappear&&k.removeElement(r.element)}),this.view.positionsAnimationTask.resolve(),this.view.chessboard.state.invokeExtensionPoints(x.animation,{type:Ve.end}),this.callback();return}let s=Math.min(1,t/this.duration),i=s<.5?2*s*s:-1+(4-2*s)*s;(isNaN(i)||i>.99)&&(i=1),this.animatedElements.forEach(r=>{if(r.element)switch(r.type){case Y.move:r.element.transform.baseVal.removeItem(0);let o=this.view.svg.createSVGTransform();o.setTranslate(r.atPoint.x+(r.toPoint.x-r.atPoint.x)*i,r.atPoint.y+(r.toPoint.y-r.atPoint.y)*i),r.element.transform.baseVal.appendItem(o);break;case Y.appear:r.element.style.opacity=Math.round(i*100)/100;break;case Y.disappear:r.element.style.opacity=Math.round((1-i)*100)/100;break}else console.warn("animatedItem has no element",r)}),this.view.chessboard.state.invokeExtensionPoints(x.animation,{type:Ve.frame,progress:i})}static squareDistance(e,t){let s=e%8,i=Math.floor(e/8),r=t%8,o=Math.floor(t/8);return Math.max(Math.abs(o-i),Math.abs(r-s))}},qe=class extends We{constructor(e){super(),this.chessboard=e}async enqueuePositionChange(e,t,s){return e.getFen()===t.getFen()?Promise.resolve():super.enqueue(()=>new Promise(i=>{let r=s?this.chessboard.props.style.animationDuration:0;this.queue.length>0&&(r=r/(1+Math.pow(this.queue.length/5,2))),new ve(this.chessboard.view,e,t,s?r:0,()=>{this.chessboard.view&&this.chessboard.view.redrawPieces(t.squares),i()})}))}async enqueueTurnBoard(e,t,s){return super.enqueue(()=>new Promise(i=>{let r=new L(le.empty),o=s?this.chessboard.props.style.animationDuration:0;this.queue.length>0&&(o=o/(1+Math.pow(this.queue.length/5,2))),new ve(this.chessboard.view,e,r,s?o:0,()=>{this.chessboard.state.orientation=t,this.chessboard.view.redrawBoard(),this.chessboard.view.redrawPieces(r.squares),new ve(this.chessboard.view,r,e,s?o:0,()=>{this.chessboard.view.redrawPieces(e.squares),i()})})}))}};var v={waitForInputStart:"waitForInputStart",pieceClickedThreshold:"pieceClickedThreshold",clickTo:"clickTo",secondClickThreshold:"secondClickThreshold",dragTo:"dragTo",clickDragTo:"clickDragTo",moveDone:"moveDone",reset:"reset"},be={secondClick:"secondClick",secondaryClick:"secondaryClick",movedOutOfBoard:"movedOutOfBoard",draggedBack:"draggedBack",clickedAnotherPiece:"clickedAnotherPiece"},Ct=4,Ie=class{constructor(e){this.view=e,this.chessboard=e.chessboard,this.moveInputState=null,this.fromSquare=null,this.toSquare=null,this.setMoveInputState(v.waitForInputStart)}moveInputStartedCallback(e){let t=this.view.moveInputStartedCallback(e);return t&&(this.chessboard.state.moveInputProcess=D.createTask(),this.chessboard.state.moveInputProcess.then(s=>{(this.moveInputState===v.waitForInputStart||this.moveInputState===v.moveDone)&&this.view.moveInputFinishedCallback(this.fromSquare,this.toSquare,s)})),t}movingOverSquareCallback(e,t){this.view.movingOverSquareCallback(e,t)}validateMoveInputCallback(e,t){let s=this.view.validateMoveInputCallback(e,t);return this.chessboard.state.moveInputProcess.resolve(s),s}moveInputCanceledCallback(e,t,s){this.view.moveInputCanceledCallback(e,t,s),this.chessboard.state.moveInputProcess.resolve()}setMoveInputState(e,t=void 0){let s=this.moveInputState;switch(this.moveInputState=e,e){case v.waitForInputStart:break;case v.pieceClickedThreshold:if(v.waitForInputStart!==s&&v.clickTo!==s)throw new Error("moveInputState");if(this.pointerMoveListener&&(removeEventListener(this.pointerMoveListener.type,this.pointerMoveListener),this.pointerMoveListener=null),this.pointerUpListener&&(removeEventListener(this.pointerUpListener.type,this.pointerUpListener),this.pointerUpListener=null),this.fromSquare=t.square,this.toSquare=null,this.movedPiece=t.piece,this.startPoint=t.point,!this.pointerMoveListener&&!this.pointerUpListener){if(t.type==="mousedown")this.pointerMoveListener=this.onPointerMove.bind(this),this.pointerMoveListener.type="mousemove",addEventListener("mousemove",this.pointerMoveListener),this.pointerUpListener=this.onPointerUp.bind(this),this.pointerUpListener.type="mouseup",addEventListener("mouseup",this.pointerUpListener);else if(t.type==="touchstart")this.pointerMoveListener=this.onPointerMove.bind(this),this.pointerMoveListener.type="touchmove",addEventListener("touchmove",this.pointerMoveListener),this.pointerUpListener=this.onPointerUp.bind(this),this.pointerUpListener.type="touchend",addEventListener("touchend",this.pointerUpListener);else throw Error("4b74af");this.contextMenuListener||(this.contextMenuListener=this.onContextMenu.bind(this),this.chessboard.view.svg.addEventListener("contextmenu",this.contextMenuListener))}else throw Error("94ad0c");break;case v.clickTo:this.draggablePiece&&(k.removeElement(this.draggablePiece),this.draggablePiece=null),s===v.dragTo&&this.view.setPieceVisibility(t.square,!0);break;case v.secondClickThreshold:if(v.clickTo!==s)throw new Error("moveInputState");this.startPoint=t.point;break;case v.dragTo:if(v.pieceClickedThreshold!==s)throw new Error("moveInputState");this.view.chessboard.state.inputEnabled()&&(this.view.setPieceVisibility(t.square,!1),this.createDraggablePiece(t.piece));break;case v.clickDragTo:if(v.secondClickThreshold!==s)throw new Error("moveInputState");this.view.chessboard.state.inputEnabled()&&(this.view.setPieceVisibility(t.square,!1),this.createDraggablePiece(t.piece));break;case v.moveDone:if([v.dragTo,v.clickTo,v.clickDragTo].indexOf(s)===-1)throw new Error("moveInputState");this.toSquare=t.square,this.toSquare&&this.validateMoveInputCallback(this.fromSquare,this.toSquare)?this.chessboard.movePiece(this.fromSquare,this.toSquare,s===v.clickTo).then(()=>{s===v.clickTo&&this.view.setPieceVisibility(this.toSquare,!0),this.setMoveInputState(v.reset)}):(this.view.setPieceVisibility(this.fromSquare,!0),this.setMoveInputState(v.reset));break;case v.reset:this.fromSquare&&!this.toSquare&&this.movedPiece&&this.chessboard.state.position.setPiece(this.fromSquare,this.movedPiece),this.fromSquare=null,this.toSquare=null,this.movedPiece=null,this.draggablePiece&&(k.removeElement(this.draggablePiece),this.draggablePiece=null),this.pointerMoveListener&&(removeEventListener(this.pointerMoveListener.type,this.pointerMoveListener),this.pointerMoveListener=null),this.pointerUpListener&&(removeEventListener(this.pointerUpListener.type,this.pointerUpListener),this.pointerUpListener=null),this.contextMenuListener&&(removeEventListener("contextmenu",this.contextMenuListener),this.contextMenuListener=null),this.setMoveInputState(v.waitForInputStart);let i=this.view.piecesGroup.querySelectorAll("[visibility=hidden]");for(let r=0;r<i.length;r++)i[r].removeAttribute("visibility");break;default:throw Error(`260b09: moveInputState ${e}`)}}createDraggablePiece(e){if(this.draggablePiece)throw Error("draggablePiece already exists");this.draggablePiece=k.createSvg(document.body),this.draggablePiece.classList.add("cm-chessboard-draggable-piece"),this.draggablePiece.setAttribute("width",this.view.squareWidth),this.draggablePiece.setAttribute("height",this.view.squareHeight),this.draggablePiece.setAttribute("style","pointer-events: none"),this.draggablePiece.name=e;let t=this.chessboard.props.assetsCache?"":this.view.getSpriteUrl(),s=k.addElement(this.draggablePiece,"use",{href:`${t}#${e}`}),i=this.view.squareHeight/this.chessboard.props.style.pieces.tileSize,r=this.draggablePiece.createSVGTransform();r.setScale(i,i),s.transform.baseVal.appendItem(r)}moveDraggablePiece(e,t){this.draggablePiece.setAttribute("style",`pointer-events: none; position: absolute; left: ${e-this.view.squareHeight/2}px; top: ${t-this.view.squareHeight/2}px`)}onPointerDown(e){if(!(e.type==="mousedown"&&e.button===0||e.type==="touchstart"))return;let t=e.target.getAttribute("data-square");if(!t)return;let s=this.chessboard.getPiece(t),i;if(s&&(i=s?s.substring(0,1):null,(i==="w"&&this.chessboard.state.inputWhiteEnabled||i==="b"&&this.chessboard.state.inputBlackEnabled)&&e.preventDefault()),this.moveInputState!==v.waitForInputStart||this.chessboard.state.inputWhiteEnabled&&i==="w"||this.chessboard.state.inputBlackEnabled&&i==="b"){let r;if(e.type==="mousedown"?r={x:e.clientX,y:e.clientY}:e.type==="touchstart"&&(r={x:e.touches[0].clientX,y:e.touches[0].clientY}),this.moveInputState===v.waitForInputStart&&s&&this.moveInputStartedCallback(t))this.setMoveInputState(v.pieceClickedThreshold,{square:t,piece:s,point:r,type:e.type});else if(this.moveInputState===v.clickTo)if(t===this.fromSquare)this.setMoveInputState(v.secondClickThreshold,{square:t,piece:s,point:r,type:e.type});else{let o=this.chessboard.getPiece(t),n=o?o.substring(0,1):null,d=this.chessboard.getPiece(this.fromSquare),p=d?d.substring(0,1):null;i&&p===n?this.validateMoveInputCallback(this.fromSquare,t)||(this.moveInputCanceledCallback(this.fromSquare,t,be.clickedAnotherPiece),this.moveInputStartedCallback(t)?this.setMoveInputState(v.pieceClickedThreshold,{square:t,piece:o,point:r,type:e.type}):this.setMoveInputState(v.reset)):this.setMoveInputState(v.moveDone,{square:t})}}}onPointerMove(e){let t,s,i,r,o;if(e.type==="mousemove"?(i=e.clientX,r=e.clientY,t=e.pageX,s=e.pageY,o=e.target):e.type==="touchmove"&&(i=e.touches[0].clientX,r=e.touches[0].clientY,t=e.touches[0].pageX,s=e.touches[0].pageY,o=document.elementFromPoint(i,r)),this.moveInputState===v.pieceClickedThreshold||this.moveInputState===v.secondClickThreshold)(Math.abs(this.startPoint.x-i)>Ct||Math.abs(this.startPoint.y-r)>Ct)&&(this.moveInputState===v.secondClickThreshold?this.setMoveInputState(v.clickDragTo,{square:this.fromSquare,piece:this.movedPiece}):this.setMoveInputState(v.dragTo,{square:this.fromSquare,piece:this.movedPiece}),this.view.chessboard.state.inputEnabled()&&this.moveDraggablePiece(t,s));else if(this.moveInputState===v.dragTo||this.moveInputState===v.clickDragTo||this.moveInputState===v.clickTo){if(o&&o.getAttribute&&o.parentElement===this.view.boardGroup){let n=o.getAttribute("data-square");n!==this.fromSquare&&n!==this.toSquare?(this.toSquare=n,this.movingOverSquareCallback(this.fromSquare,this.toSquare)):n===this.fromSquare&&this.toSquare!==null&&(this.toSquare=null,this.movingOverSquareCallback(this.fromSquare,null))}else this.toSquare!==null&&(this.toSquare=null,this.movingOverSquareCallback(this.fromSquare,null));this.view.chessboard.state.inputEnabled()&&(this.moveInputState===v.dragTo||this.moveInputState===v.clickDragTo)&&this.moveDraggablePiece(t,s)}}onPointerUp(e){let t;if(e.type==="mouseup"?t=e.target:e.type==="touchend"&&(t=document.elementFromPoint(e.changedTouches[0].clientX,e.changedTouches[0].clientY)),t&&t.getAttribute){let s=t.getAttribute("data-square");if(s)this.moveInputState===v.dragTo||this.moveInputState===v.clickDragTo?this.fromSquare===s?this.moveInputState===v.clickDragTo?(this.chessboard.state.position.setPiece(this.fromSquare,this.movedPiece),this.view.setPieceVisibility(this.fromSquare),this.moveInputCanceledCallback(s,null,be.draggedBack),this.setMoveInputState(v.reset)):this.setMoveInputState(v.clickTo,{square:s}):this.setMoveInputState(v.moveDone,{square:s}):this.moveInputState===v.pieceClickedThreshold?this.setMoveInputState(v.clickTo,{square:s}):this.moveInputState===v.secondClickThreshold&&(this.setMoveInputState(v.reset),this.moveInputCanceledCallback(s,null,be.secondClick));else{this.view.redrawPieces();let i=this.fromSquare;this.setMoveInputState(v.reset),this.moveInputCanceledCallback(i,null,be.movedOutOfBoard)}}else this.view.redrawPieces(),this.setMoveInputState(v.reset)}onContextMenu(e){e.preventDefault(),this.view.redrawPieces(),this.setMoveInputState(v.reset),this.moveInputCanceledCallback(this.fromSquare,null,be.secondaryClick)}isDragging(){return this.moveInputState===v.dragTo||this.moveInputState===v.clickDragTo}destroy(){this.setMoveInputState(v.reset)}};var H={white:"w",black:"b"},z={moveInputStarted:"moveInputStarted",movingOverSquare:"movingOverSquare",validateMoveInput:"validateMoveInput",moveInputCanceled:"moveInputCanceled",moveInputFinished:"moveInputFinished"},xt={pointercancel:"pointercancel",pointerdown:"pointerdown",pointerenter:"pointerenter",pointerleave:"pointerleave",pointermove:"pointermove",pointerout:"pointerout",pointerover:"pointerover",pointerup:"pointerup"},te={none:"none",thin:"thin",frame:"frame"},Ae=class{constructor(e){this.chessboard=e,this.visualMoveInput=new Ie(this),e.props.assetsCache&&this.cacheSpriteToDiv("cm-chessboard-sprite",this.getSpriteUrl()),this.container=document.createElement("div"),this.chessboard.context.appendChild(this.container),e.props.responsive&&(typeof ResizeObserver<"u"?(this.resizeObserver=new ResizeObserver(()=>{setTimeout(()=>{this.handleResize()})}),this.resizeObserver.observe(this.chessboard.context)):(this.resizeListener=this.handleResize.bind(this),window.addEventListener("resize",this.resizeListener))),this.positionsAnimationTask=Promise.resolve(),this.pointerDownListener=this.pointerDownHandler.bind(this),this.container.addEventListener("mousedown",this.pointerDownListener),this.container.addEventListener("touchstart",this.pointerDownListener,{passive:!1}),this.createSvgAndGroups(),this.handleResize()}pointerDownHandler(e){this.visualMoveInput.onPointerDown(e)}destroy(){this.visualMoveInput.destroy(),this.resizeObserver&&this.resizeObserver.unobserve(this.chessboard.context),this.resizeListener&&window.removeEventListener("resize",this.resizeListener),this.chessboard.context.removeEventListener("mousedown",this.pointerDownListener),this.chessboard.context.removeEventListener("touchstart",this.pointerDownListener),k.removeElement(this.svg),this.container.remove()}cacheSpriteToDiv(e,t){if(!document.getElementById(e)){let s=document.createElement("div");s.style.transform="scale(0)",s.style.position="absolute",s.setAttribute("aria-hidden","true"),s.id=e,document.body.appendChild(s);let i=new XMLHttpRequest;i.open("GET",t,!0),i.onload=function(){s.insertAdjacentHTML("afterbegin",i.response)},i.send()}}createSvgAndGroups(){this.svg=k.createSvg(this.container);let e=this.chessboard.props.style.cssClass?this.chessboard.props.style.cssClass:"default";this.svg.setAttribute("class","cm-chessboard border-type-"+this.chessboard.props.style.borderType+" "+e),this.svg.setAttribute("role","img"),this.updateMetrics(),this.boardGroup=k.addElement(this.svg,"g",{class:"board"}),this.coordinatesGroup=k.addElement(this.svg,"g",{class:"coordinates","aria-hidden":"true"}),this.markersLayer=k.addElement(this.svg,"g",{class:"markers-layer"}),this.piecesLayer=k.addElement(this.svg,"g",{class:"pieces-layer"}),this.piecesGroup=k.addElement(this.piecesLayer,"g",{class:"pieces"}),this.markersTopLayer=k.addElement(this.svg,"g",{class:"markers-top-layer"}),this.interactiveTopLayer=k.addElement(this.svg,"g",{class:"interactive-top-layer"})}updateMetrics(){let e=this.chessboard.props.style.pieces.tileSize;this.width=this.container.clientWidth,this.height=this.container.clientWidth*(this.chessboard.props.style.aspectRatio||1),this.chessboard.props.style.borderType===te.frame?this.borderSize=this.width/25:this.chessboard.props.style.borderType===te.thin?this.borderSize=this.width/320:this.borderSize=0,this.innerWidth=this.width-2*this.borderSize,this.innerHeight=this.height-2*this.borderSize,this.squareWidth=this.innerWidth/8,this.squareHeight=this.innerHeight/8,this.scalingX=this.squareWidth/e,this.scalingY=this.squareHeight/e,this.pieceXTranslate=this.squareWidth/2-e*this.scalingY/2}handleResize(){this.container.style.width=this.chessboard.context.clientWidth+"px",this.container.style.height=this.chessboard.context.clientWidth*this.chessboard.props.style.aspectRatio+"px",(this.container.clientWidth!==this.width||this.container.clientHeight!==this.height)&&(this.updateMetrics(),this.redrawBoard(),this.redrawPieces()),this.svg.setAttribute("width","100%"),this.svg.setAttribute("height","100%")}redrawBoard(){this.chessboard.state.invokeExtensionPoints(x.beforeRedrawBoard),this.redrawSquares(),this.drawCoordinates(),this.chessboard.state.invokeExtensionPoints(x.afterRedrawBoard),this.visualizeInputState()}redrawSquares(){for(;this.boardGroup.firstChild;)this.boardGroup.removeChild(this.boardGroup.lastChild);if(k.addElement(this.boardGroup,"rect",{width:this.width,height:this.height}).setAttribute("class","border"),this.chessboard.props.style.borderType===te.frame){let t=this.borderSize;k.addElement(this.boardGroup,"rect",{x:t,y:t,width:this.width-t*2,height:this.height-t*2}).setAttribute("class","border-inner")}for(let t=0;t<64;t++){let s=this.chessboard.state.orientation===H.white?t:63-t,r=`square ${(9*s&8)===0?"black":"white"}`,o=this.squareToPoint(L.indexToSquare(s)),n=k.addElement(this.boardGroup,"rect",{x:o.x,y:o.y,width:this.squareWidth,height:this.squareHeight});n.setAttribute("class",r),n.setAttribute("data-square",L.indexToSquare(s))}}drawCoordinates(){if(!this.chessboard.props.style.showCoordinates)return;for(;this.coordinatesGroup.firstChild;)this.coordinatesGroup.removeChild(this.coordinatesGroup.lastChild);let e=this.chessboard.props.style.borderType!==te.frame;for(let t=0;t<8;t++){let s=this.borderSize+(17+this.chessboard.props.style.pieces.tileSize*t)*this.scalingX,i=this.height-this.scalingY*3.5,r="coordinate file";e&&(s=s+this.scalingX*15.5,r+=t%2?" white":" black");let o=k.addElement(this.coordinatesGroup,"text",{class:r,x:s,y:i,style:`font-size: ${this.scalingY*10}px`});this.chessboard.state.orientation===H.white?o.textContent=String.fromCharCode(97+t):o.textContent=String.fromCharCode(104-t)}for(let t=0;t<8;t++){let s=this.borderSize/3.7,i=this.borderSize+25*this.scalingY+t*this.squareHeight,r="coordinate rank";e&&(r+=t%2?" black":" white",this.chessboard.props.style.borderType===te.frame?(s=s+this.scalingX*10,i=i-this.scalingY*15):(s=s+this.scalingX*2,i=i-this.scalingY*15));let o=k.addElement(this.coordinatesGroup,"text",{class:r,x:s,y:i,style:`font-size: ${this.scalingY*10}px`});this.chessboard.state.orientation===H.white?o.textContent=""+(8-t):o.textContent=""+(1+t)}}redrawPieces(e=this.chessboard.state.position.squares){let t=Array.from(this.piecesGroup.childNodes),s=this.visualMoveInput.isDragging();for(let i=0;i<64;i++){let r=e[i];if(r){let o=L.indexToSquare(i);this.drawPieceOnSquare(o,r,s&&o===this.visualMoveInput.fromSquare)}}for(let i of t)this.piecesGroup.removeChild(i)}drawPiece(e,t,s){let i=k.addElement(e,"g",{});i.setAttribute("data-piece",t);let r=this.svg.createSVGTransform();r.setTranslate(s.x,s.y),i.transform.baseVal.appendItem(r);let o=this.chessboard.props.assetsCache?"":this.getSpriteUrl(),n=k.addElement(i,"use",{href:`${o}#${t}`,class:"piece"}),d=this.svg.createSVGTransform();return d.setScale(this.scalingY,this.scalingY),n.transform.baseVal.appendItem(d),i}drawPieceOnSquare(e,t,s=!1){let i=k.addElement(this.piecesGroup,"g",{});i.setAttribute("data-piece",t),i.setAttribute("data-square",e),s&&i.setAttribute("visibility","hidden");let r=this.squareToPoint(e),o=this.svg.createSVGTransform();o.setTranslate(r.x,r.y),i.transform.baseVal.appendItem(o);let n=this.chessboard.props.assetsCache?"":this.getSpriteUrl(),d=k.addElement(i,"use",{href:`${n}#${t}`,class:"piece"}),p=this.svg.createSVGTransform();p.setTranslate(this.pieceXTranslate,0),d.transform.baseVal.appendItem(p);let g=this.svg.createSVGTransform();return g.setScale(this.scalingY,this.scalingY),d.transform.baseVal.appendItem(g),i}setPieceVisibility(e,t=!0){let s=this.getPieceElement(e);s?t?s.setAttribute("visibility","visible"):s.setAttribute("visibility","hidden"):console.warn("no piece on",e)}getPieceElement(e){if(!e||e.length<2)return console.warn("invalid square",e),null;let t=this.piecesGroup.querySelector(`g[data-square='${e}']`);return t||(console.warn("no piece on",e),null)}enableMoveInput(e,t=null){if(this.chessboard.state.moveInputCallback)throw Error("moveInput already enabled");t===H.white?this.chessboard.state.inputWhiteEnabled=!0:t===H.black?this.chessboard.state.inputBlackEnabled=!0:(this.chessboard.state.inputWhiteEnabled=!0,this.chessboard.state.inputBlackEnabled=!0),this.chessboard.state.moveInputCallback=e,this.chessboard.state.invokeExtensionPoints(x.moveInputToggled,{enabled:!0,color:t}),this.visualizeInputState()}disableMoveInput(){this.chessboard.state.inputWhiteEnabled=!1,this.chessboard.state.inputBlackEnabled=!1,this.chessboard.state.moveInputCallback=null,this.chessboard.state.invokeExtensionPoints(x.moveInputToggled,{enabled:!1}),this.visualizeInputState()}moveInputStartedCallback(e){let t={chessboard:this.chessboard,type:z.moveInputStarted,square:e,squareFrom:e,piece:this.chessboard.getPiece(e)};return this.chessboard.state.moveInputCallback&&(t.moveInputCallbackResult=this.chessboard.state.moveInputCallback(t)),this.chessboard.state.invokeExtensionPoints(x.moveInput,t),t.moveInputCallbackResult}movingOverSquareCallback(e,t){let s={chessboard:this.chessboard,type:z.movingOverSquare,squareFrom:e,squareTo:t,piece:this.chessboard.getPiece(e)};this.chessboard.state.moveInputCallback&&(s.moveInputCallbackResult=this.chessboard.state.moveInputCallback(s)),this.chessboard.state.invokeExtensionPoints(x.moveInput,s)}validateMoveInputCallback(e,t){let s={chessboard:this.chessboard,type:z.validateMoveInput,squareFrom:e,squareTo:t,piece:this.chessboard.getPiece(e)};return this.chessboard.state.moveInputCallback&&(s.moveInputCallbackResult=this.chessboard.state.moveInputCallback(s)),this.chessboard.state.invokeExtensionPoints(x.moveInput,s),s.moveInputCallbackResult}moveInputCanceledCallback(e,t,s){let i={chessboard:this.chessboard,type:z.moveInputCanceled,reason:s,squareFrom:e,squareTo:t};this.chessboard.state.moveInputCallback&&this.chessboard.state.moveInputCallback(i),this.chessboard.state.invokeExtensionPoints(x.moveInput,i)}moveInputFinishedCallback(e,t,s){let i={chessboard:this.chessboard,type:z.moveInputFinished,squareFrom:e,squareTo:t,legalMove:s};this.chessboard.state.moveInputCallback&&this.chessboard.state.moveInputCallback(i),this.chessboard.state.invokeExtensionPoints(x.moveInput,i)}visualizeInputState(){this.chessboard.state&&(this.chessboard.state.inputWhiteEnabled||this.chessboard.state.inputBlackEnabled?this.boardGroup.setAttribute("class","board input-enabled"):this.boardGroup.setAttribute("class","board"))}indexToPoint(e){let t,s;return this.chessboard.state.orientation===H.white?(t=this.borderSize+e%8*this.squareWidth,s=this.borderSize+(7-Math.floor(e/8))*this.squareHeight):(t=this.borderSize+(7-e%8)*this.squareWidth,s=this.borderSize+Math.floor(e/8)*this.squareHeight),{x:t,y:s}}squareToPoint(e){let t=L.squareToIndex(e);return this.indexToPoint(t)}getSpriteUrl(){return D.isAbsoluteUrl(this.chessboard.props.style.pieces.file)?this.chessboard.props.style.pieces.file:this.chessboard.props.assetsUrl+this.chessboard.props.style.pieces.file}};var j={wp:"wp",wb:"wb",wn:"wn",wr:"wr",wq:"wq",wk:"wk",bp:"bp",bb:"bb",bn:"bn",br:"br",bq:"bq",bk:"bk"};var Os={svgSprite:"svgSprite"};var Me=class{constructor(e,t={}){if(!e)throw new Error("container element is "+e);this.context=e,this.id=(Math.random()+1).toString(36).substring(2,8),this.extensions=[],this.props={position:le.empty,orientation:H.white,responsive:!0,assetsUrl:"./assets/",assetsCache:!0,style:{cssClass:"default",showCoordinates:!0,borderType:te.none,aspectRatio:1,pieces:{type:Os.svgSprite,file:"pieces/standard.svg",tileSize:40},animationDuration:300},extensions:[]},D.mergeObjects(this.props,t),this.state=new Te,this.view=new Ae(this),this.positionAnimationsQueue=new qe(this),this.state.orientation=this.props.orientation;for(let s of this.props.extensions)this.addExtension(s.class,s.props);this.view.redrawBoard(),this.state.position=new L(this.props.position),this.view.redrawPieces(),this.state.invokeExtensionPoints(x.positionChanged),this.initialized=Promise.resolve()}async setPiece(e,t,s=!1){let i=this.state.position.clone();return this.state.position.setPiece(e,t),this.state.invokeExtensionPoints(x.positionChanged),this.positionAnimationsQueue.enqueuePositionChange(i,this.state.position.clone(),s)}async movePiece(e,t,s=!1){let i=this.state.position.clone();return this.state.position.movePiece(e,t),this.state.invokeExtensionPoints(x.positionChanged),this.positionAnimationsQueue.enqueuePositionChange(i,this.state.position.clone(),s)}async setPosition(e,t=!1){let s=this.state.position.clone(),i=new L(e);return s.getFen()!==i.getFen()&&(this.state.position.setFen(e),this.state.invokeExtensionPoints(x.positionChanged)),this.positionAnimationsQueue.enqueuePositionChange(s,this.state.position.clone(),t)}async setOrientation(e,t=!1){let s=this.state.position.clone();if(this.boardTurning){console.warn("setOrientation is only once in queue allowed");return}return this.boardTurning=!0,this.positionAnimationsQueue.enqueueTurnBoard(s,e,t).then(()=>{this.boardTurning=!1,this.state.invokeExtensionPoints(x.boardChanged)})}getPiece(e){return this.state.position.getPiece(e)}getPosition(){return this.state.position.getFen()}getOrientation(){return this.state.orientation}enableMoveInput(e,t=void 0){this.view.enableMoveInput(e,t)}disableMoveInput(){this.view.disableMoveInput()}isMoveInputEnabled(){return this.state.inputWhiteEnabled||this.state.inputBlackEnabled}enableSquareSelect(e=xt.pointerdown,t){this.squareSelectListener||(this.squareSelectListener=function(s){let i=s.target.getAttribute("data-square");t({eventType:s.type,event:s,chessboard:this,square:i})}),this.context.addEventListener(e,this.squareSelectListener),this.state.squareSelectEnabled=!0,this.view.visualizeInputState()}disableSquareSelect(e){this.context.removeEventListener(e,this.squareSelectListener),this.squareSelectListener=void 0,this.state.squareSelectEnabled=!1,this.view.visualizeInputState()}isSquareSelectEnabled(){return this.state.squareSelectEnabled}addExtension(e,t){if(this.getExtension(e))throw Error('extension "'+e.name+'" already added');this.extensions.push(new e(this,t))}getExtension(e){for(let t of this.extensions)if(t instanceof e)return t;return null}destroy(){this.state.invokeExtensionPoints(x.destroy),this.positionAnimationsQueue.destroy(),this.view.destroy(),this.view=void 0,this.state=void 0}};var se={frame:{class:"marker-frame",slice:"markerFrame"},framePrimary:{class:"marker-frame-primary",slice:"markerFrame"},frameDanger:{class:"marker-frame-danger",slice:"markerFrame"},circle:{class:"marker-circle",slice:"markerCircle"},circlePrimary:{class:"marker-circle-primary",slice:"markerCircle"},circleDanger:{class:"marker-circle-danger",slice:"markerCircle"},circleDangerFilled:{class:"marker-circle-danger-filled",slice:"markerCircleFilled"},square:{class:"marker-square",slice:"markerSquare"},dot:{class:"marker-dot",slice:"markerDot",position:"above"},bevel:{class:"marker-bevel",slice:"markerBevel"}},Oe=class extends Q{constructor(e,t={}){super(e),this.registerExtensionPoint(x.afterRedrawBoard,()=>{this.onRedrawBoard()}),this.props={autoMarkers:se.frame,sprite:"extensions/markers/markers.svg"},Object.assign(this.props,t),e.props.assetsCache&&e.view.cacheSpriteToDiv("cm-chessboard-markers",this.getSpriteUrl()),e.addMarker=this.addMarker.bind(this),e.getMarkers=this.getMarkers.bind(this),e.removeMarkers=this.removeMarkers.bind(this),e.addLegalMovesMarkers=this.addLegalMovesMarkers.bind(this),e.removeLegalMovesMarkers=this.removeLegalMovesMarkers.bind(this),this.markerGroupDown=k.addElement(e.view.markersLayer,"g",{class:"markers"}),this.markerGroupUp=k.addElement(e.view.markersTopLayer,"g",{class:"markers"}),this.markers=[],this.props.autoMarkers&&(Object.assign(this.props.autoMarkers,this.props.autoMarkers),this.registerExtensionPoint(x.moveInput,s=>{this.drawAutoMarkers(s)}))}drawAutoMarkers(e){e.type!==z.moveInputFinished&&this.removeMarkers(this.props.autoMarkers),!(e.type===z.moveInputStarted&&!e.moveInputCallbackResult)&&(e.type===z.moveInputStarted||e.type===z.movingOverSquare)&&(e.squareFrom&&this.addMarker(this.props.autoMarkers,e.squareFrom),e.squareTo&&this.addMarker(this.props.autoMarkers,e.squareTo))}onRedrawBoard(){for(;this.markerGroupUp.firstChild;)this.markerGroupUp.removeChild(this.markerGroupUp.firstChild);for(;this.markerGroupDown.firstChild;)this.markerGroupDown.removeChild(this.markerGroupDown.firstChild);this.markers.forEach(e=>{this.drawMarker(e)})}addLegalMovesMarkers(e){for(let t of e)t.promotion&&t.promotion!=="q"||(this.chessboard.getPiece(t.to)?this.chessboard.addMarker(se.bevel,t.to):this.chessboard.addMarker(se.dot,t.to))}removeLegalMovesMarkers(){this.chessboard.removeMarkers(se.bevel),this.chessboard.removeMarkers(se.dot)}drawMarker(e){let t;e.type.position==="above"?t=k.addElement(this.markerGroupUp,"g"):t=k.addElement(this.markerGroupDown,"g"),t.setAttribute("data-square",e.square);let s=this.chessboard.view.squareToPoint(e.square),i=this.chessboard.view.svg.createSVGTransform();i.setTranslate(s.x,s.y),t.transform.baseVal.appendItem(i);let r=this.chessboard.props.assetsCache?"":this.getSpriteUrl(),o=k.addElement(t,"use",{href:`${r}#${e.type.slice}`,class:"marker "+e.type.class}),n=this.chessboard.view.svg.createSVGTransform();return n.setScale(this.chessboard.view.scalingX,this.chessboard.view.scalingY),o.transform.baseVal.appendItem(n),t}addMarker(e,t){if(typeof e=="string"||typeof t=="object"){console.error("changed the signature of `addMarker` to `(type, square)` with v5.1.x");return}this.markers.push(new Ye(t,e)),this.onRedrawBoard()}getMarkers(e=void 0,t=void 0){if(typeof e=="string"||typeof t=="object"){console.error("changed the signature of `getMarkers` to `(type, square)` with v5.1.x");return}let s=[];return this.markers.forEach(i=>{i.matches(t,e)&&s.push(i)}),s}removeMarkers(e=void 0,t=void 0){if(typeof e=="string"||typeof t=="object"){console.error("changed the signature of `removeMarkers` to `(type, square)` with v5.1.x");return}this.markers=this.markers.filter(s=>!s.matches(t,e)),this.onRedrawBoard()}getSpriteUrl(){return D.isAbsoluteUrl(this.props.sprite)?this.props.sprite:this.chessboard.props.assetsUrl+this.props.sprite}},Ye=class{constructor(e,t){this.square=e,this.type=t}matches(e=void 0,t=void 0){if(!t&&!e)return!0;if(t){if(e){if(this.type===t&&e===this.square)return!0}else if(this.type===t)return!0}else if(e===this.square)return!0;return!1}};var Tt={default:{class:"arrow-success"},success:{class:"arrow-success"},secondary:{class:"arrow-secondary"},warning:{class:"arrow-warning"},info:{class:"arrow-info"},danger:{class:"arrow-danger"}},Le=class extends Q{constructor(e,t={}){super(e),this.registerExtensionPoint(x.afterRedrawBoard,()=>{this.onRedrawBoard()}),this.props={sprite:"extensions/arrows/arrows.svg",slice:"arrowDefault",headSize:7,offsetFrom:0,offsetTo:.55},Object.assign(this.props,t),this.chessboard.props.assetsCache&&this.chessboard.view.cacheSpriteToDiv("cm-chessboard-arrows",this.getSpriteUrl()),e.addArrow=this.addArrow.bind(this),e.getArrows=this.getArrows.bind(this),e.removeArrows=this.removeArrows.bind(this),this.arrowGroup=k.addElement(e.view.markersTopLayer,"g",{class:"arrows"}),this.arrows=[]}onRedrawBoard(){for(;this.arrowGroup.firstChild;)this.arrowGroup.removeChild(this.arrowGroup.firstChild);this.arrows.forEach(e=>{this.drawArrow(e)})}drawArrow(e){let t=this.chessboard.view,s=k.addElement(this.arrowGroup,"g");s.setAttribute("data-arrow",e.from+e.to),s.setAttribute("class","arrow "+e.type.class);let i=t.squareToPoint(e.from),r=t.squareToPoint(e.to),o=this.chessboard.props.assetsCache?"":this.getSpriteUrl(),n=k.addElement(s,"defs"),d="arrow-"+e.from+e.to,p=k.addElement(n,"marker",{id:d,markerWidth:this.props.headSize,markerHeight:this.props.headSize,refX:20,refY:20,viewBox:"0 0 40 40",orient:"auto",class:"arrow-head"});k.addElement(p,"use",{href:`${o}#${this.props.slice}`});let g=i.x+t.squareWidth/2,P=i.y+t.squareHeight/2,m=r.x+t.squareWidth/2,w=r.y+t.squareHeight/2,C=m-g,q=w-P,B=Math.hypot(C,q)||1,oe=C/B,ne=q/B,Ee=Math.min(t.squareWidth,t.squareHeight)/2,de=Ge=>Math.max(0,Math.min(1,Ge)),pe=Ee*de(this.props.offsetFrom),fe=Ee*de(this.props.offsetTo),Ke=g+oe*pe,me=P+ne*pe,ke=m-oe*fe,ae=w-ne*fe,ye=(t.scalingX+t.scalingY)/2*8,V=k.addElement(s,"line");V.setAttribute("x1",Ke.toString()),V.setAttribute("x2",ke.toString()),V.setAttribute("y1",me.toString()),V.setAttribute("y2",ae.toString()),V.setAttribute("class","arrow-line"),V.setAttribute("marker-end","url(#"+d+")"),V.setAttribute("stroke-width",ye+"px")}addArrow(e,t,s){this.arrows.push(new je(t,s,e)),this.chessboard.view.redrawBoard()}getArrows(e=void 0,t=void 0,s=void 0){let i=[];return this.arrows.forEach(r=>{r.matches(t,s,e)&&i.push(r)}),i}removeArrows(e=void 0,t=void 0,s=void 0){this.arrows=this.arrows.filter(i=>!i.matches(t,s,e)),this.chessboard.view.redrawBoard()}getSpriteUrl(){return D.isAbsoluteUrl(this.props.sprite)?this.props.sprite:this.chessboard.props.assetsUrl+this.props.sprite}},je=class{constructor(e,t,s){this.from=e,this.to=t,this.type=s}matches(e=void 0,t=void 0,s=void 0){return e&&e!==this.from||t&&t!==this.to?!1:!(s&&s!==this.type)}};var F={hidden:"hidden",displayRequested:"displayRequested",shown:"shown"},Ls={de:{choosePromotion:"Bauernumwandlung w\xE4hlen",promotionDialogTitle:"Bauernumwandlung",pieces:{q:"Dame",r:"Turm",b:"L\xE4ufer",n:"Springer"},promoteTo:"Umwandeln in"},en:{choosePromotion:"Choose promotion piece",promotionDialogTitle:"Pawn promotion",pieces:{q:"Queen",r:"Rook",b:"Bishop",n:"Knight"},promoteTo:"Promote to"}},Ne={pieceSelected:"pieceSelected",canceled:"canceled"},De=class extends Q{constructor(e,t={}){super(e),this.props={language:navigator.language.substring(0,2).toLowerCase()},Object.assign(this.props,t),this.props.language!=="de"&&this.props.language!=="en"&&(this.props.language="en"),this.t=Ls[this.props.language],this.pieceOrder=["q","r","b","n"],this.focusedIndex=0,this.previouslyFocusedElement=null,this.registerExtensionPoint(x.afterRedrawBoard,this.extensionPointRedrawBoard.bind(this)),this.registerExtensionPoint(x.destroy,this.destroy.bind(this)),e.showPromotionDialog=this.showPromotionDialog.bind(this),e.isPromotionDialogShown=this.isPromotionDialogShown.bind(this),this.promotionDialogGroup=k.addElement(e.view.interactiveTopLayer,"g",{class:"promotion-dialog-group",role:"dialog","aria-modal":"true","aria-label":this.t.choosePromotion}),this.liveRegion=document.createElement("div"),this.liveRegion.setAttribute("aria-live","polite"),this.liveRegion.setAttribute("aria-atomic","true"),this.liveRegion.className="cm-chessboard-promotion-live-region visually-hidden",this.liveRegion.style.cssText="position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;",e.context.appendChild(this.liveRegion),this.state={displayState:F.hidden,callback:null,dialogParams:{square:null,color:null}},this.handleKeyDown=this.handleKeyDown.bind(this)}showPromotionDialog(e,t,s){this.previouslyFocusedElement=document.activeElement,this.focusedIndex=0,this.state.dialogParams.square=e,this.state.dialogParams.color=t,this.state.callback=s,this.setDisplayState(F.displayRequested),setTimeout(()=>{this.chessboard.view.positionsAnimationTask.then(()=>{this.setDisplayState(F.shown),this.announce(this.t.choosePromotion+": "+this.pieceOrder.map(i=>this.t.pieces[i]).join(", "))})})}isPromotionDialogShown(){return this.state.displayState===F.shown||this.state.displayState===F.displayRequested}extensionPointRedrawBoard(){this.redrawDialog()}drawPieceButton(e,t,s){let i=this.chessboard.view.squareWidth,r=this.chessboard.view.squareHeight,o=e.charAt(1),n=this.t.pieces[o],d=k.addElement(this.promotionDialogGroup,"g",{class:"promotion-dialog-button-group",role:"button",tabindex:s===0?"0":"-1","aria-label":n,"data-piece":e,"data-index":s});k.addElement(d,"rect",{x:t.x,y:t.y,width:i,height:r,class:"promotion-dialog-button","data-piece":e}),this.chessboard.view.drawPiece(d,e,t)}redrawDialog(){for(;this.promotionDialogGroup.firstChild;)this.promotionDialogGroup.removeChild(this.promotionDialogGroup.firstChild);if(this.state.displayState===F.shown){let e=this.chessboard.view.squareWidth,t=this.chessboard.view.squareHeight,s=this.chessboard.view.squareToPoint(this.state.dialogParams.square);s.x=s.x+e/2,s.y=s.y+t/2;let i=!1,r=parseInt(this.state.dialogParams.square.charAt(1),10);(this.chessboard.getOrientation()===H.white&&r<5||this.chessboard.getOrientation()===H.black&&r>=5)&&(i=!0);let o=i?-4*t:0,n=s.x+e>this.chessboard.view.width?-e:0;k.addElement(this.promotionDialogGroup,"rect",{x:s.x+n,y:s.y+o,width:e,height:t*4,class:"promotion-dialog"});let d=this.state.dialogParams;i?(this.drawPieceButton(j[d.color+"q"],{x:s.x+n,y:s.y-t},0),this.drawPieceButton(j[d.color+"r"],{x:s.x+n,y:s.y-t*2},1),this.drawPieceButton(j[d.color+"b"],{x:s.x+n,y:s.y-t*3},2),this.drawPieceButton(j[d.color+"n"],{x:s.x+n,y:s.y-t*4},3)):(this.drawPieceButton(j[d.color+"q"],{x:s.x+n,y:s.y},0),this.drawPieceButton(j[d.color+"r"],{x:s.x+n,y:s.y+t},1),this.drawPieceButton(j[d.color+"b"],{x:s.x+n,y:s.y+t*2},2),this.drawPieceButton(j[d.color+"n"],{x:s.x+n,y:s.y+t*3},3))}}promotionDialogOnClickPiece(e){if(e.button!==2){let t=e.target.dataset.piece;if(!t&&e.target.closest){let s=e.target.closest(".promotion-dialog-button-group");s&&(t=s.dataset.piece)}t?this.selectPiece(t):this.promotionDialogOnCancel(e)}}selectPiece(e){this.state.callback&&this.state.callback({type:Ne.pieceSelected,square:this.state.dialogParams.square,piece:e}),this.setDisplayState(F.hidden)}promotionDialogOnCancel(e){this.state.displayState===F.shown&&(e.preventDefault(),this.setDisplayState(F.hidden),this.state.callback&&this.state.callback({type:Ne.canceled}))}contextMenu(e){e.preventDefault(),this.setDisplayState(F.hidden),this.state.callback&&this.state.callback({type:Ne.canceled})}setDisplayState(e){this.state.displayState=e,e===F.shown?(this.clickDelegate=D.delegate(this.chessboard.view.svg,"pointerdown","*",this.promotionDialogOnClickPiece.bind(this)),this.contextMenuListener=this.contextMenu.bind(this),this.chessboard.view.svg.addEventListener("contextmenu",this.contextMenuListener),document.addEventListener("keydown",this.handleKeyDown)):e===F.hidden&&(this.clickDelegate.remove(),this.chessboard.view.svg.removeEventListener("contextmenu",this.contextMenuListener),document.removeEventListener("keydown",this.handleKeyDown),this.previouslyFocusedElement&&this.previouslyFocusedElement.focus&&this.previouslyFocusedElement.focus()),this.redrawDialog(),e===F.shown&&setTimeout(()=>{this.focusButton(0)},0)}handleKeyDown(e){if(this.state.displayState===F.shown)switch(e.key){case"ArrowDown":case"ArrowRight":e.preventDefault(),this.focusedIndex=(this.focusedIndex+1)%4,this.focusButton(this.focusedIndex);break;case"ArrowUp":case"ArrowLeft":e.preventDefault(),this.focusedIndex=(this.focusedIndex-1+4)%4,this.focusButton(this.focusedIndex);break;case"Enter":case" ":e.preventDefault();let t=this.promotionDialogGroup.querySelectorAll(".promotion-dialog-button-group");if(t[this.focusedIndex]){let s=t[this.focusedIndex].dataset.piece;this.selectPiece(s)}break;case"Escape":e.preventDefault(),this.setDisplayState(F.hidden),this.state.callback&&this.state.callback({type:Ne.canceled});break;case"Tab":e.preventDefault(),e.shiftKey?this.focusedIndex=(this.focusedIndex-1+4)%4:this.focusedIndex=(this.focusedIndex+1)%4,this.focusButton(this.focusedIndex);break}}focusButton(e){let t=this.promotionDialogGroup.querySelectorAll(".promotion-dialog-button-group");if(t.forEach((s,i)=>{s.setAttribute("tabindex",i===e?"0":"-1")}),t[e]){t[e].focus();let s=this.pieceOrder[e];this.announce(this.t.pieces[s])}}announce(e){this.liveRegion.textContent="",setTimeout(()=>{this.liveRegion.textContent=e},50)}destroy(){document.removeEventListener("keydown",this.handleKeyDown),this.liveRegion&&this.liveRegion.parentNode&&this.liveRegion.parentNode.removeChild(this.liveRegion)}};function Ns(h){return h!==null?{comment:h,variations:[]}:{variations:[]}}function Ds(h,e,t,s,i){let r={move:h,variations:i};return e&&(r.suffix=e),t&&(r.nag=t),s!==null&&(r.comment=s),r}function $s(...h){let[e,...t]=h,s=e;for(let i of t)i!==null&&(s.variations=[i,...i.variations],i.variations=[],s=i);return e}function Rs(h,e){if(e.marker&&e.marker.comment){let t=e.root;for(;;){let s=t.variations[0];if(!s){t.comment=e.marker.comment;break}t=s}}return{headers:h,root:e.root,result:(e.marker&&e.marker.result)??void 0}}function Fs(h,e){function t(){this.constructor=h}t.prototype=e.prototype,h.prototype=new t}function ue(h,e,t,s){var i=Error.call(this,h);return Object.setPrototypeOf&&Object.setPrototypeOf(i,ue.prototype),i.expected=e,i.found=t,i.location=s,i.name="SyntaxError",i}Fs(ue,Error);function Qe(h,e,t){return t=t||" ",h.length>e?h:(e-=h.length,t+=t.repeat(e),h+t.slice(0,e))}ue.prototype.format=function(h){var e="Error: "+this.message;if(this.location){var t=null,s;for(s=0;s<h.length;s++)if(h[s].source===this.location.source){t=h[s].text.split(/\r\n|\n|\r/g);break}var i=this.location.start,r=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(i):i,o=this.location.source+":"+r.line+":"+r.column;if(t){var n=this.location.end,d=Qe("",r.line.toString().length," "),p=t[i.line-1],g=i.line===n.line?n.column:p.length+1,P=g-i.column||1;e+=`
 --> `+o+`
`+d+` |
`+r.line+" | "+p+`
`+d+" | "+Qe("",i.column-1," ")+Qe("",P,"^")}else e+=`
 at `+o}return e};ue.buildMessage=function(h,e){var t={literal:function(p){return'"'+i(p.text)+'"'},class:function(p){var g=p.parts.map(function(P){return Array.isArray(P)?r(P[0])+"-"+r(P[1]):r(P)});return"["+(p.inverted?"^":"")+g.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(p){return p.description}};function s(p){return p.charCodeAt(0).toString(16).toUpperCase()}function i(p){return p.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(g){return"\\x0"+s(g)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(g){return"\\x"+s(g)})}function r(p){return p.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(g){return"\\x0"+s(g)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(g){return"\\x"+s(g)})}function o(p){return t[p.type](p)}function n(p){var g=p.map(o),P,m;if(g.sort(),g.length>0){for(P=1,m=1;P<g.length;P++)g[P-1]!==g[P]&&(g[m]=g[P],m++);g.length=m}switch(g.length){case 1:return g[0];case 2:return g[0]+" or "+g[1];default:return g.slice(0,-1).join(", ")+", or "+g[g.length-1]}}function d(p){return p?'"'+i(p)+'"':"end of input"}return"Expected "+n(h)+" but "+d(e)+" found."};function Us(h,e){e=e!==void 0?e:{};var t={},s=e.grammarSource,i={pgn:_t},r=_t,o="[",n='"',d="]",p=".",g="O-O-O",P="O-O",m="0-0-0",w="0-0",C="$",q="{",B="}",oe=";",ne="(",Ee=")",de="1-0",pe="0-1",fe="1/2-1/2",Ke="*",me=/^[a-zA-Z]/,ke=/^[^"]/,ae=/^[0-9]/,ye=/^[.]/,V=/^[a-zA-Z1-8\-=]/,Ge=/^[+#]/,ot=/^[!?]/,nt=/^[^}]/,at=/^[^\r\n]/,ht=/^[ \t\r\n]/,Lt=K("tag pair"),Nt=M("[",!1),lt=M('"',!1),Dt=M("]",!1),$t=K("tag name"),He=W([["a","z"],["A","Z"]],!1,!1),Rt=K("tag value"),ct=W(['"'],!0,!1),Ft=K("move number"),Pe=W([["0","9"]],!1,!1),Ut=M(".",!1),ut=W(["."],!1,!1),Bt=K("standard algebraic notation"),Kt=M("O-O-O",!1),Gt=M("O-O",!1),Ht=M("0-0-0",!1),zt=M("0-0",!1),dt=W([["a","z"],["A","Z"],["1","8"],"-","="],!1,!1),Vt=W(["+","#"],!1,!1),Wt=K("suffix annotation"),pt=W(["!","?"],!1,!1),Yt=K("NAG"),jt=M("$",!1),Qt=K("brace comment"),Xt=M("{",!1),ft=W(["}"],!0,!1),Zt=M("}",!1),Jt=K("rest of line comment"),es=M(";",!1),mt=W(["\r",`
`],!0,!1),ts=K("variation"),ss=M("(",!1),is=M(")",!1),rs=K("game termination marker"),os=M("1-0",!1),ns=M("0-1",!1),as=M("1/2-1/2",!1),hs=M("*",!1),ls=K("whitespace"),gt=W([" ","	","\r",`
`],!1,!1),cs=function(a,c){return Rs(a,c)},us=function(a){return Object.fromEntries(a)},ds=function(a,c){return[a,c]},ps=function(a,c){return{root:a,marker:c}},fs=function(a,c){return $s(Ns(a),...c.flat())},ms=function(a,c,u,_,S){return Ds(a,c,u,_,S)},gs=function(a){return a},vs=function(a){return a.replace(/[\r\n]+/g," ")},bs=function(a){return a.trim()},_s=function(a){return a},ws=function(a,c){return{result:a,comment:c}},l=e.peg$currPos|0,he=[{line:1,column:1}],G=l,Ce=e.peg$maxFailExpected||[],f=e.peg$silentFails|0,ge;if(e.startRule){if(!(e.startRule in i))throw new Error(`Can't start parsing from rule "`+e.startRule+'".');r=i[e.startRule]}function M(a,c){return{type:"literal",text:a,ignoreCase:c}}function W(a,c,u){return{type:"class",parts:a,inverted:c,ignoreCase:u}}function Ss(){return{type:"end"}}function K(a){return{type:"other",description:a}}function vt(a){var c=he[a],u;if(c)return c;if(a>=he.length)u=he.length-1;else for(u=a;!he[--u];);for(c=he[u],c={line:c.line,column:c.column};u<a;)h.charCodeAt(u)===10?(c.line++,c.column=1):c.column++,u++;return he[a]=c,c}function bt(a,c,u){var _=vt(a),S=vt(c),T={source:s,start:{offset:a,line:_.line,column:_.column},end:{offset:c,line:S.line,column:S.column}};return T}function b(a){l<G||(l>G&&(G=l,Ce=[]),Ce.push(a))}function Es(a,c,u){return new ue(ue.buildMessage(a,c),a,c,u)}function _t(){var a,c,u;return a=l,c=ks(),u=Cs(),a=cs(c,u),a}function ks(){var a,c,u;for(a=l,c=[],u=wt();u!==t;)c.push(u),u=wt();return u=R(),a=us(c),a}function wt(){var a,c,u,_,S,T,ee;return f++,a=l,R(),h.charCodeAt(l)===91?(c=o,l++):(c=t,f===0&&b(Nt)),c!==t?(R(),u=ys(),u!==t?(R(),h.charCodeAt(l)===34?(_=n,l++):(_=t,f===0&&b(lt)),_!==t?(S=Ps(),h.charCodeAt(l)===34?(T=n,l++):(T=t,f===0&&b(lt)),T!==t?(R(),h.charCodeAt(l)===93?(ee=d,l++):(ee=t,f===0&&b(Dt)),ee!==t?a=ds(u,S):(l=a,a=t)):(l=a,a=t)):(l=a,a=t)):(l=a,a=t)):(l=a,a=t),f--,a===t&&f===0&&b(Lt),a}function ys(){var a,c,u;if(f++,a=l,c=[],u=h.charAt(l),me.test(u)?l++:(u=t,f===0&&b(He)),u!==t)for(;u!==t;)c.push(u),u=h.charAt(l),me.test(u)?l++:(u=t,f===0&&b(He));else c=t;return c!==t?a=h.substring(a,l):a=c,f--,a===t&&(c=t,f===0&&b($t)),a}function Ps(){var a,c,u;for(f++,a=l,c=[],u=h.charAt(l),ke.test(u)?l++:(u=t,f===0&&b(ct));u!==t;)c.push(u),u=h.charAt(l),ke.test(u)?l++:(u=t,f===0&&b(ct));return a=h.substring(a,l),f--,c=t,f===0&&b(Rt),a}function Cs(){var a,c,u;return a=l,c=St(),R(),u=Ms(),u===t&&(u=null),R(),a=ps(c,u),a}function St(){var a,c,u,_;for(a=l,c=ze(),c===t&&(c=null),u=[],_=Et();_!==t;)u.push(_),_=Et();return a=fs(c,u),a}function Et(){var a,c,u,_,S,T,ee,xe;if(a=l,R(),xs(),R(),c=Ts(),c!==t){for(u=qs(),u===t&&(u=null),_=[],S=kt();S!==t;)_.push(S),S=kt();for(S=R(),T=ze(),T===t&&(T=null),ee=[],xe=yt();xe!==t;)ee.push(xe),xe=yt();a=ms(c,u,_,T,ee)}else l=a,a=t;return a}function xs(){var a,c,u,_,S,T;for(f++,a=l,c=[],u=h.charAt(l),ae.test(u)?l++:(u=t,f===0&&b(Pe));u!==t;)c.push(u),u=h.charAt(l),ae.test(u)?l++:(u=t,f===0&&b(Pe));if(h.charCodeAt(l)===46?(u=p,l++):(u=t,f===0&&b(Ut)),u!==t){for(_=R(),S=[],T=h.charAt(l),ye.test(T)?l++:(T=t,f===0&&b(ut));T!==t;)S.push(T),T=h.charAt(l),ye.test(T)?l++:(T=t,f===0&&b(ut));c=[c,u,_,S],a=c}else l=a,a=t;return f--,a===t&&(c=t,f===0&&b(Ft)),a}function Ts(){var a,c,u,_,S,T;if(f++,a=l,c=l,h.substr(l,5)===g?(u=g,l+=5):(u=t,f===0&&b(Kt)),u===t&&(h.substr(l,3)===P?(u=P,l+=3):(u=t,f===0&&b(Gt)),u===t&&(h.substr(l,5)===m?(u=m,l+=5):(u=t,f===0&&b(Ht)),u===t&&(h.substr(l,3)===w?(u=w,l+=3):(u=t,f===0&&b(zt)),u===t))))if(u=l,_=h.charAt(l),me.test(_)?l++:(_=t,f===0&&b(He)),_!==t){if(S=[],T=h.charAt(l),V.test(T)?l++:(T=t,f===0&&b(dt)),T!==t)for(;T!==t;)S.push(T),T=h.charAt(l),V.test(T)?l++:(T=t,f===0&&b(dt));else S=t;S!==t?(_=[_,S],u=_):(l=u,u=t)}else l=u,u=t;return u!==t?(_=h.charAt(l),Ge.test(_)?l++:(_=t,f===0&&b(Vt)),_===t&&(_=null),u=[u,_],c=u):(l=c,c=t),c!==t?a=h.substring(a,l):a=c,f--,a===t&&(c=t,f===0&&b(Bt)),a}function qs(){var a,c,u;for(f++,a=l,c=[],u=h.charAt(l),ot.test(u)?l++:(u=t,f===0&&b(pt));u!==t;)c.push(u),c.length>=2?u=t:(u=h.charAt(l),ot.test(u)?l++:(u=t,f===0&&b(pt)));return c.length<1?(l=a,a=t):a=c,f--,a===t&&(c=t,f===0&&b(Wt)),a}function kt(){var a,c,u,_,S;if(f++,a=l,R(),h.charCodeAt(l)===36?(c=C,l++):(c=t,f===0&&b(jt)),c!==t){if(u=l,_=[],S=h.charAt(l),ae.test(S)?l++:(S=t,f===0&&b(Pe)),S!==t)for(;S!==t;)_.push(S),S=h.charAt(l),ae.test(S)?l++:(S=t,f===0&&b(Pe));else _=t;_!==t?u=h.substring(u,l):u=_,u!==t?a=gs(u):(l=a,a=t)}else l=a,a=t;return f--,a===t&&f===0&&b(Yt),a}function ze(){var a;return a=Is(),a===t&&(a=As()),a}function Is(){var a,c,u,_,S;if(f++,a=l,h.charCodeAt(l)===123?(c=q,l++):(c=t,f===0&&b(Xt)),c!==t){for(u=l,_=[],S=h.charAt(l),nt.test(S)?l++:(S=t,f===0&&b(ft));S!==t;)_.push(S),S=h.charAt(l),nt.test(S)?l++:(S=t,f===0&&b(ft));u=h.substring(u,l),h.charCodeAt(l)===125?(_=B,l++):(_=t,f===0&&b(Zt)),_!==t?a=vs(u):(l=a,a=t)}else l=a,a=t;return f--,a===t&&(c=t,f===0&&b(Qt)),a}function As(){var a,c,u,_,S;if(f++,a=l,h.charCodeAt(l)===59?(c=oe,l++):(c=t,f===0&&b(es)),c!==t){for(u=l,_=[],S=h.charAt(l),at.test(S)?l++:(S=t,f===0&&b(mt));S!==t;)_.push(S),S=h.charAt(l),at.test(S)?l++:(S=t,f===0&&b(mt));u=h.substring(u,l),a=bs(u)}else l=a,a=t;return f--,a===t&&(c=t,f===0&&b(Jt)),a}function yt(){var a,c,u,_;return f++,a=l,R(),h.charCodeAt(l)===40?(c=ne,l++):(c=t,f===0&&b(ss)),c!==t?(u=St(),u!==t?(R(),h.charCodeAt(l)===41?(_=Ee,l++):(_=t,f===0&&b(is)),_!==t?a=_s(u):(l=a,a=t)):(l=a,a=t)):(l=a,a=t),f--,a===t&&f===0&&b(ts),a}function Ms(){var a,c,u;return f++,a=l,h.substr(l,3)===de?(c=de,l+=3):(c=t,f===0&&b(os)),c===t&&(h.substr(l,3)===pe?(c=pe,l+=3):(c=t,f===0&&b(ns)),c===t&&(h.substr(l,7)===fe?(c=fe,l+=7):(c=t,f===0&&b(as)),c===t&&(h.charCodeAt(l)===42?(c=Ke,l++):(c=t,f===0&&b(hs))))),c!==t?(R(),u=ze(),u===t&&(u=null),a=ws(c,u)):(l=a,a=t),f--,a===t&&(c=t,f===0&&b(rs)),a}function R(){var a,c;for(f++,a=[],c=h.charAt(l),ht.test(c)?l++:(c=t,f===0&&b(gt));c!==t;)a.push(c),c=h.charAt(l),ht.test(c)?l++:(c=t,f===0&&b(gt));return f--,c=t,f===0&&b(ls),a}if(ge=r(),e.peg$library)return{peg$result:ge,peg$currPos:l,peg$FAILED:t,peg$maxFailExpected:Ce,peg$maxFailPos:G};if(ge!==t&&l===h.length)return ge;throw ge!==t&&l<h.length&&b(Ss()),Es(Ce,G<h.length?h.charAt(G):null,G<h.length?bt(G,G+1):bt(G,G))}var Re=0xffffffffffffffffn;function Xe(h,e){return(h<<e|h>>64n-e)&0xffffffffffffffffn}function qt(h,e){return h*e&Re}function Bs(h){return function(){let e=BigInt(h&Re),t=BigInt(h>>64n&Re),s=qt(Xe(qt(e,5n),7n),9n);return t^=e,e=(Xe(e,24n)^t^t<<16n)&Re,t=Xe(t,37n),h=t<<64n|e,s}}var Be=Bs(0xa187eb39cdcaed8f31c4b365b102e01en),Ks=Array.from({length:2},()=>Array.from({length:6},()=>Array.from({length:128},()=>Be()))),Gs=Array.from({length:8},()=>Be()),Hs=Array.from({length:16},()=>Be()),Ze=Be(),$="w",U="b",I="p",it="n",Fe="b",we="r",J="q",A="k",Je="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",ce=class{color;from;to;piece;captured;promotion;flags;san;lan;before;after;constructor(e,t){let{color:s,piece:i,from:r,to:o,flags:n,captured:d,promotion:p}=t,g=O(r),P=O(o);this.color=s,this.piece=i,this.from=g,this.to=P,this.san=e._moveToSan(t,e._moves({legal:!0})),this.lan=g+P,this.before=e.fen(),e._makeMove(t),this.after=e.fen(),e._undoMove(),this.flags="";for(let m in y)y[m]&n&&(this.flags+=ie[m]);d&&(this.captured=d),p&&(this.promotion=p,this.lan+=p)}isCapture(){return this.flags.indexOf(ie.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(ie.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(ie.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(ie.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(ie.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(ie.BIG_PAWN)>-1}},N=-1,ie={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q",NULL_MOVE:"-"};var y={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64,NULL_MOVE:128},rt={Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:"*"},zs={WhiteTitle:null,BlackTitle:null,WhiteElo:null,BlackElo:null,WhiteUSCF:null,BlackUSCF:null,WhiteNA:null,BlackNA:null,WhiteType:null,BlackType:null,EventDate:null,EventSponsor:null,Section:null,Stage:null,Board:null,Opening:null,Variation:null,SubVariation:null,ECO:null,NIC:null,Time:null,UTCTime:null,UTCDate:null,TimeControl:null,SetUp:null,FEN:null,Termination:null,Annotator:null,Mode:null,PlyCount:null},Vs={...rt,...zs},E={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},et={b:[16,32,17,15],w:[-16,-32,-17,-15]},It={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},Ws=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],Ys=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],js={p:1,n:2,b:4,r:8,q:16,k:32},Qs="pnbrqkPNBRQK",At=[it,Fe,we,J],Xs=7,Zs=6,Js=1,ei=0,$e={[A]:y.KSIDE_CASTLE,[J]:y.QSIDE_CASTLE},X={w:[{square:E.a1,flag:y.QSIDE_CASTLE},{square:E.h1,flag:y.KSIDE_CASTLE}],b:[{square:E.a8,flag:y.QSIDE_CASTLE},{square:E.h8,flag:y.KSIDE_CASTLE}]},ti={b:Js,w:Zs},tt="--";function re(h){return h>>4}function Se(h){return h&15}function Ot(h){return"0123456789".indexOf(h)!==-1}function O(h){let e=Se(h),t=re(h);return"abcdefgh".substring(e,e+1)+"87654321".substring(t,t+1)}function _e(h){return h===$?U:$}function si(h){let e=h.split(/\s+/);if(e.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};let t=parseInt(e[5],10);if(isNaN(t)||t<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};let s=parseInt(e[4],10);if(isNaN(s)||s<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(e[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(e[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(e[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};let i=e[0].split("/");if(i.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let o=0;o<i.length;o++){let n=0,d=!1;for(let p=0;p<i[o].length;p++)if(Ot(i[o][p])){if(d)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};n+=parseInt(i[o][p],10),d=!0}else{if(!/^[prnbqkPRNBQK]$/.test(i[o][p]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};n+=1,d=!1}if(n!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(e[3][1]=="3"&&e[1]=="w"||e[3][1]=="6"&&e[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};let r=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(let{color:o,regex:n}of r){if(!n.test(e[0]))return{ok:!1,error:`Invalid FEN: missing ${o} king`};if((e[0].match(n)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${o} kings`}}return Array.from(i[0]+i[7]).some(o=>o.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function ii(h,e){let t=h.from,s=h.to,i=h.piece,r=0,o=0,n=0;for(let d=0,p=e.length;d<p;d++){let g=e[d].from,P=e[d].to,m=e[d].piece;i===m&&t!==g&&s===P&&(r++,re(t)===re(g)&&o++,Se(t)===Se(g)&&n++)}return r>0?o>0&&n>0?O(t):n>0?O(t).charAt(1):O(t).charAt(0):""}function Z(h,e,t,s,i,r=void 0,o=y.NORMAL){let n=re(s);if(i===I&&(n===Xs||n===ei))for(let d=0;d<At.length;d++){let p=At[d];h.push({color:e,from:t,to:s,piece:i,captured:r,promotion:p,flags:o|y.PROMOTION})}else h.push({color:e,from:t,to:s,piece:i,captured:r,flags:o})}function Mt(h){let e=h.charAt(0);return e>="a"&&e<="h"?h.match(/[a-h]\d.*[a-h]\d/)?void 0:I:(e=e.toLowerCase(),e==="o"?A:e)}function st(h){return h.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}var Ue=class{_board=new Array(128);_turn=$;_header={};_kings={w:N,b:N};_epSquare=-1;_halfMoves=0;_moveNumber=0;_history=[];_comments={};_castling={w:0,b:0};_hash=0n;_positionCount=new Map;constructor(e=Je,{skipValidation:t=!1}={}){this.load(e,{skipValidation:t})}clear({preserveHeaders:e=!1}={}){this._board=new Array(128),this._kings={w:N,b:N},this._turn=$,this._castling={w:0,b:0},this._epSquare=N,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=e?this._header:{...Vs},this._hash=this._computeHash(),this._positionCount=new Map,this._header.SetUp=null,this._header.FEN=null}load(e,{skipValidation:t=!1,preserveHeaders:s=!1}={}){let i=e.split(/\s+/);if(i.length>=2&&i.length<6){let n=["-","-","0","1"];e=i.concat(n.slice(-(6-i.length))).join(" ")}if(i=e.split(/\s+/),!t){let{ok:n,error:d}=si(e);if(!n)throw new Error(d)}let r=i[0],o=0;this.clear({preserveHeaders:s});for(let n=0;n<r.length;n++){let d=r.charAt(n);if(d==="/")o+=8;else if(Ot(d))o+=parseInt(d,10);else{let p=d<"a"?$:U;this._put({type:d.toLowerCase(),color:p},O(o)),o++}}this._turn=i[1],i[2].indexOf("K")>-1&&(this._castling.w|=y.KSIDE_CASTLE),i[2].indexOf("Q")>-1&&(this._castling.w|=y.QSIDE_CASTLE),i[2].indexOf("k")>-1&&(this._castling.b|=y.KSIDE_CASTLE),i[2].indexOf("q")>-1&&(this._castling.b|=y.QSIDE_CASTLE),this._epSquare=i[3]==="-"?N:E[i[3]],this._halfMoves=parseInt(i[4],10),this._moveNumber=parseInt(i[5],10),this._hash=this._computeHash(),this._updateSetup(e),this._incPositionCount()}fen({forceEnpassantSquare:e=!1}={}){let t=0,s="";for(let o=E.a8;o<=E.h1;o++){if(this._board[o]){t>0&&(s+=t,t=0);let{color:n,type:d}=this._board[o];s+=n===$?d.toUpperCase():d.toLowerCase()}else t++;o+1&136&&(t>0&&(s+=t),o!==E.h1&&(s+="/"),t=0,o+=8)}let i="";this._castling[$]&y.KSIDE_CASTLE&&(i+="K"),this._castling[$]&y.QSIDE_CASTLE&&(i+="Q"),this._castling[U]&y.KSIDE_CASTLE&&(i+="k"),this._castling[U]&y.QSIDE_CASTLE&&(i+="q"),i=i||"-";let r="-";if(this._epSquare!==N)if(e)r=O(this._epSquare);else{let o=this._epSquare+(this._turn===$?16:-16),n=[o+1,o-1];for(let d of n){if(d&136)continue;let p=this._turn;if(this._board[d]?.color===p&&this._board[d]?.type===I){this._makeMove({color:p,from:d,to:this._epSquare,piece:I,captured:I,flags:y.EP_CAPTURE});let g=!this._isKingAttacked(p);if(this._undoMove(),g){r=O(this._epSquare);break}}}}return[s,this._turn,i,r,this._halfMoves,this._moveNumber].join(" ")}_pieceKey(e){if(!this._board[e])return 0n;let{color:t,type:s}=this._board[e],i={w:0,b:1}[t],r={p:0,n:1,b:2,r:3,q:4,k:5}[s];return Ks[i][r][e]}_epKey(){return this._epSquare===N?0n:Gs[this._epSquare&7]}_castlingKey(){let e=this._castling.w>>5|this._castling.b>>3;return Hs[e]}_computeHash(){let e=0n;for(let t=E.a8;t<=E.h1;t++){if(t&136){t+=7;continue}this._board[t]&&(e^=this._pieceKey(t))}return e^=this._epKey(),e^=this._castlingKey(),this._turn==="b"&&(e^=Ze),e}_updateSetup(e){this._history.length>0||(e!==Je?(this._header.SetUp="1",this._header.FEN=e):(this._header.SetUp=null,this._header.FEN=null))}reset(){this.load(Je)}get(e){return this._board[E[e]]}findPiece(e){let t=[];for(let s=E.a8;s<=E.h1;s++){if(s&136){s+=7;continue}!this._board[s]||this._board[s]?.color!==e.color||this._board[s].color===e.color&&this._board[s].type===e.type&&t.push(O(s))}return t}put({type:e,color:t},s){return this._put({type:e,color:t},s)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_set(e,t){this._hash^=this._pieceKey(e),this._board[e]=t,this._hash^=this._pieceKey(e)}_put({type:e,color:t},s){if(Qs.indexOf(e.toLowerCase())===-1||!(s in E))return!1;let i=E[s];if(e==A&&!(this._kings[t]==N||this._kings[t]==i))return!1;let r=this._board[i];return r&&r.type===A&&(this._kings[r.color]=N),this._set(i,{type:e,color:t}),e===A&&(this._kings[t]=i),!0}_clear(e){this._hash^=this._pieceKey(e),delete this._board[e]}remove(e){let t=this.get(e);return this._clear(E[e]),t&&t.type===A&&(this._kings[t.color]=N),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),t}_updateCastlingRights(){this._hash^=this._castlingKey();let e=this._board[E.e1]?.type===A&&this._board[E.e1]?.color===$,t=this._board[E.e8]?.type===A&&this._board[E.e8]?.color===U;(!e||this._board[E.a1]?.type!==we||this._board[E.a1]?.color!==$)&&(this._castling.w&=-65),(!e||this._board[E.h1]?.type!==we||this._board[E.h1]?.color!==$)&&(this._castling.w&=-33),(!t||this._board[E.a8]?.type!==we||this._board[E.a8]?.color!==U)&&(this._castling.b&=-65),(!t||this._board[E.h8]?.type!==we||this._board[E.h8]?.color!==U)&&(this._castling.b&=-33),this._hash^=this._castlingKey()}_updateEnPassantSquare(){if(this._epSquare===N)return;let e=this._epSquare+(this._turn===$?-16:16),t=this._epSquare+(this._turn===$?16:-16),s=[t+1,t-1];if(this._board[e]!==null||this._board[this._epSquare]!==null||this._board[t]?.color!==_e(this._turn)||this._board[t]?.type!==I){this._hash^=this._epKey(),this._epSquare=N;return}let i=r=>!(r&136)&&this._board[r]?.color===this._turn&&this._board[r]?.type===I;s.some(i)||(this._hash^=this._epKey(),this._epSquare=N)}_attacked(e,t,s){let i=[];for(let r=E.a8;r<=E.h1;r++){if(r&136){r+=7;continue}if(this._board[r]===void 0||this._board[r].color!==e)continue;let o=this._board[r],n=r-t;if(n===0)continue;let d=n+119;if(Ws[d]&js[o.type]){if(o.type===I){if(n>0&&o.color===$||n<=0&&o.color===U)if(s)i.push(O(r));else return!0;continue}if(o.type==="n"||o.type==="k")if(s){i.push(O(r));continue}else return!0;let p=Ys[d],g=r+p,P=!1;for(;g!==t;){if(this._board[g]!=null){P=!0;break}g+=p}if(!P)if(s){i.push(O(r));continue}else return!0}}return s?i:!1}attackers(e,t){return t?this._attacked(t,E[e],!0):this._attacked(this._turn,E[e],!0)}_isKingAttacked(e){let t=this._kings[e];return t===-1?!1:this._attacked(_e(e),t)}hash(){return this._hash.toString(16)}isAttacked(e,t){return this._attacked(t,E[e])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){let e={b:0,n:0,r:0,q:0,k:0,p:0},t=[],s=0,i=0;for(let r=E.a8;r<=E.h1;r++){if(i=(i+1)%2,r&136){r+=7;continue}let o=this._board[r];o&&(e[o.type]=o.type in e?e[o.type]+1:1,o.type===Fe&&t.push(i),s++)}if(s===2)return!0;if(s===3&&(e[Fe]===1||e[it]===1))return!0;if(s===e[Fe]+2){let r=0,o=t.length;for(let n=0;n<o;n++)r+=t[n];if(r===0||r===o)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this._hash)>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isDraw()}moves({verbose:e=!1,square:t=void 0,piece:s=void 0}={}){let i=this._moves({square:t,piece:s});return e?i.map(r=>new ce(this,r)):i.map(r=>this._moveToSan(r,i))}_moves({legal:e=!0,piece:t=void 0,square:s=void 0}={}){let i=s?s.toLowerCase():void 0,r=t?.toLowerCase(),o=[],n=this._turn,d=_e(n),p=E.a8,g=E.h1,P=!1;if(i)if(i in E)p=g=E[i],P=!0;else return[];for(let w=p;w<=g;w++){if(w&136){w+=7;continue}if(!this._board[w]||this._board[w].color===d)continue;let{type:C}=this._board[w],q;if(C===I){if(r&&r!==C)continue;q=w+et[n][0],this._board[q]||(Z(o,n,w,q,I),q=w+et[n][1],ti[n]===re(w)&&!this._board[q]&&Z(o,n,w,q,I,void 0,y.BIG_PAWN));for(let B=2;B<4;B++)q=w+et[n][B],!(q&136)&&(this._board[q]?.color===d?Z(o,n,w,q,I,this._board[q].type,y.CAPTURE):q===this._epSquare&&Z(o,n,w,q,I,I,y.EP_CAPTURE))}else{if(r&&r!==C)continue;for(let B=0,oe=It[C].length;B<oe;B++){let ne=It[C][B];for(q=w;q+=ne,!(q&136);){if(!this._board[q])Z(o,n,w,q,C);else{if(this._board[q].color===n)break;Z(o,n,w,q,C,this._board[q].type,y.CAPTURE);break}if(C===it||C===A)break}}}}if((r===void 0||r===A)&&(!P||g===this._kings[n])){if(this._castling[n]&y.KSIDE_CASTLE){let w=this._kings[n],C=w+2;!this._board[w+1]&&!this._board[C]&&!this._attacked(d,this._kings[n])&&!this._attacked(d,w+1)&&!this._attacked(d,C)&&Z(o,n,this._kings[n],C,A,void 0,y.KSIDE_CASTLE)}if(this._castling[n]&y.QSIDE_CASTLE){let w=this._kings[n],C=w-2;!this._board[w-1]&&!this._board[w-2]&&!this._board[w-3]&&!this._attacked(d,this._kings[n])&&!this._attacked(d,w-1)&&!this._attacked(d,C)&&Z(o,n,this._kings[n],C,A,void 0,y.QSIDE_CASTLE)}}if(!e||this._kings[n]===-1)return o;let m=[];for(let w=0,C=o.length;w<C;w++)this._makeMove(o[w]),this._isKingAttacked(n)||m.push(o[w]),this._undoMove();return m}move(e,{strict:t=!1}={}){let s=null;if(typeof e=="string")s=this._moveFromSan(e,t);else if(e===null)s=this._moveFromSan(tt,t);else if(typeof e=="object"){let r=this._moves();for(let o=0,n=r.length;o<n;o++)if(e.from===O(r[o].from)&&e.to===O(r[o].to)&&(!("promotion"in r[o])||e.promotion===r[o].promotion)){s=r[o];break}}if(!s)throw typeof e=="string"?new Error(`Invalid move: ${e}`):new Error(`Invalid move: ${JSON.stringify(e)}`);if(this.isCheck()&&s.flags&y.NULL_MOVE)throw new Error("Null move not allowed when in check");let i=new ce(this,s);return this._makeMove(s),this._incPositionCount(),i}_push(e){this._history.push({move:e,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_movePiece(e,t){this._hash^=this._pieceKey(e),this._board[t]=this._board[e],delete this._board[e],this._hash^=this._pieceKey(t)}_makeMove(e){let t=this._turn,s=_e(t);if(this._push(e),e.flags&y.NULL_MOVE){t===U&&this._moveNumber++,this._halfMoves++,this._turn=s,this._epSquare=N;return}if(this._hash^=this._epKey(),this._hash^=this._castlingKey(),e.captured&&(this._hash^=this._pieceKey(e.to)),this._movePiece(e.from,e.to),e.flags&y.EP_CAPTURE&&(this._turn===U?this._clear(e.to-16):this._clear(e.to+16)),e.promotion&&(this._clear(e.to),this._set(e.to,{type:e.promotion,color:t})),this._board[e.to].type===A){if(this._kings[t]=e.to,e.flags&y.KSIDE_CASTLE){let i=e.to-1,r=e.to+1;this._movePiece(r,i)}else if(e.flags&y.QSIDE_CASTLE){let i=e.to+1,r=e.to-2;this._movePiece(r,i)}this._castling[t]=0}if(this._castling[t]){for(let i=0,r=X[t].length;i<r;i++)if(e.from===X[t][i].square&&this._castling[t]&X[t][i].flag){this._castling[t]^=X[t][i].flag;break}}if(this._castling[s]){for(let i=0,r=X[s].length;i<r;i++)if(e.to===X[s][i].square&&this._castling[s]&X[s][i].flag){this._castling[s]^=X[s][i].flag;break}}if(this._hash^=this._castlingKey(),e.flags&y.BIG_PAWN){let i;t===U?i=e.to-16:i=e.to+16,!(e.to-1&136)&&this._board[e.to-1]?.type===I&&this._board[e.to-1]?.color===s||!(e.to+1&136)&&this._board[e.to+1]?.type===I&&this._board[e.to+1]?.color===s?(this._epSquare=i,this._hash^=this._epKey()):this._epSquare=N}else this._epSquare=N;e.piece===I?this._halfMoves=0:e.flags&(y.CAPTURE|y.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,t===U&&this._moveNumber++,this._turn=s,this._hash^=Ze}undo(){let e=this._hash,t=this._undoMove();if(t){let s=new ce(this,t);return this._decPositionCount(e),s}return null}_undoMove(){let e=this._history.pop();if(e===void 0)return null;this._hash^=this._epKey(),this._hash^=this._castlingKey();let t=e.move;this._kings=e.kings,this._turn=e.turn,this._castling=e.castling,this._epSquare=e.epSquare,this._halfMoves=e.halfMoves,this._moveNumber=e.moveNumber,this._hash^=this._epKey(),this._hash^=this._castlingKey(),this._hash^=Ze;let s=this._turn,i=_e(s);if(t.flags&y.NULL_MOVE)return t;if(this._movePiece(t.to,t.from),t.piece&&(this._clear(t.from),this._set(t.from,{type:t.piece,color:s})),t.captured)if(t.flags&y.EP_CAPTURE){let r;s===U?r=t.to-16:r=t.to+16,this._set(r,{type:I,color:i})}else this._set(t.to,{type:t.captured,color:i});if(t.flags&(y.KSIDE_CASTLE|y.QSIDE_CASTLE)){let r,o;t.flags&y.KSIDE_CASTLE?(r=t.to+1,o=t.to-1):(r=t.to-2,o=t.to+1),this._movePiece(o,r)}return t}pgn({newline:e=`
`,maxWidth:t=0}={}){let s=[],i=!1;for(let m in this._header)this._header[m]&&s.push(`[${m} "${this._header[m]}"]`+e),i=!0;i&&this._history.length&&s.push(e);let r=m=>{let w=this._comments[this.fen()];if(typeof w<"u"){let C=m.length>0?" ":"";m=`${m}${C}{${w}}`}return m},o=[];for(;this._history.length>0;)o.push(this._undoMove());let n=[],d="";for(o.length===0&&n.push(r(""));o.length>0;){d=r(d);let m=o.pop();if(!m)break;if(!this._history.length&&m.color==="b"){let w=`${this._moveNumber}. ...`;d=d?`${d} ${w}`:w}else m.color==="w"&&(d.length&&n.push(d),d=this._moveNumber+".");d=d+" "+this._moveToSan(m,this._moves({legal:!0})),this._makeMove(m)}if(d.length&&n.push(r(d)),n.push(this._header.Result||"*"),t===0)return s.join("")+n.join(" ");let p=function(){return s.length>0&&s[s.length-1]===" "?(s.pop(),!0):!1},g=function(m,w){for(let C of w.split(" "))if(C){if(m+C.length>t){for(;p();)m--;s.push(e),m=0}s.push(C),m+=C.length,s.push(" "),m++}return p()&&m--,m},P=0;for(let m=0;m<n.length;m++){if(P+n[m].length>t&&n[m].includes("{")){P=g(P,n[m]);continue}P+n[m].length>t&&m!==0?(s[s.length-1]===" "&&s.pop(),s.push(e),P=0):m!==0&&(s.push(" "),P++),s.push(n[m]),P+=n[m].length}return s.join("")}header(...e){for(let t=0;t<e.length;t+=2)typeof e[t]=="string"&&typeof e[t+1]=="string"&&(this._header[e[t]]=e[t+1]);return this._header}setHeader(e,t){return this._header[e]=t??rt[e]??null,this.getHeaders()}removeHeader(e){return e in this._header?(this._header[e]=rt[e]||null,!0):!1}getHeaders(){let e={};for(let[t,s]of Object.entries(this._header))s!==null&&(e[t]=s);return e}loadPgn(e,{strict:t=!1,newlineChar:s=`\r?
`}={}){s!==`\r?
`&&(e=e.replace(new RegExp(s,"g"),`
`));let i=Us(e);this.reset();let r=i.headers,o="";for(let p in r)p.toLowerCase()==="fen"&&(o=r[p]),this.header(p,r[p]);if(!t)o&&this.load(o,{preserveHeaders:!0});else if(r.SetUp==="1"){if(!("FEN"in r))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(r.FEN,{preserveHeaders:!0})}let n=i.root;for(;n;){if(n.move){let p=this._moveFromSan(n.move,t);if(p==null)throw new Error(`Invalid move in PGN: ${n.move}`);this._makeMove(p),this._incPositionCount()}n.comment!==void 0&&(this._comments[this.fen()]=n.comment),n=n.variations[0]}let d=i.result;d&&Object.keys(this._header).length&&this._header.Result!==d&&this.setHeader("Result",d)}_moveToSan(e,t){let s="";if(e.flags&y.KSIDE_CASTLE)s="O-O";else if(e.flags&y.QSIDE_CASTLE)s="O-O-O";else{if(e.flags&y.NULL_MOVE)return tt;if(e.piece!==I){let i=ii(e,t);s+=e.piece.toUpperCase()+i}e.flags&(y.CAPTURE|y.EP_CAPTURE)&&(e.piece===I&&(s+=O(e.from)[0]),s+="x"),s+=O(e.to),e.promotion&&(s+="="+e.promotion.toUpperCase())}return this._makeMove(e),this.isCheck()&&(this.isCheckmate()?s+="#":s+="+"),this._undoMove(),s}_moveFromSan(e,t=!1){let s=st(e);if(t||(s==="0-0"?s="O-O":s==="0-0-0"&&(s="O-O-O")),s==tt)return{color:this._turn,from:0,to:0,piece:"k",flags:y.NULL_MOVE};let i=Mt(s),r=this._moves({legal:!0,piece:i});for(let m=0,w=r.length;m<w;m++)if(s===st(this._moveToSan(r[m],r)))return r[m];if(t)return null;let o,n,d,p,g,P=!1;if(n=s.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),n?(o=n[1],d=n[2],p=n[3],g=n[4],d.length==1&&(P=!0)):(n=s.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),n&&(o=n[1],d=n[2],p=n[3],g=n[4],d.length==1&&(P=!0))),i=Mt(s),r=this._moves({legal:!0,piece:o||i}),!p)return null;for(let m=0,w=r.length;m<w;m++)if(d){if((!o||o.toLowerCase()==r[m].piece)&&E[d]==r[m].from&&E[p]==r[m].to&&(!g||g.toLowerCase()==r[m].promotion))return r[m];if(P){let C=O(r[m].from);if((!o||o.toLowerCase()==r[m].piece)&&E[p]==r[m].to&&(d==C[0]||d==C[1])&&(!g||g.toLowerCase()==r[m].promotion))return r[m]}}else if(s===st(this._moveToSan(r[m],r)).replace("x",""))return r[m];return null}ascii(){let e=`   +------------------------+
`;for(let t=E.a8;t<=E.h1;t++){if(Se(t)===0&&(e+=" "+"87654321"[re(t)]+" |"),this._board[t]){let s=this._board[t].type,r=this._board[t].color===$?s.toUpperCase():s.toLowerCase();e+=" "+r+" "}else e+=" . ";t+1&136&&(e+=`|
`,t+=8)}return e+=`   +------------------------+
`,e+="     a  b  c  d  e  f  g  h",e}perft(e){let t=this._moves({legal:!1}),s=0,i=this._turn;for(let r=0,o=t.length;r<o;r++)this._makeMove(t[r]),this._isKingAttacked(i)||(e-1>0?s+=this.perft(e-1):s++),this._undoMove();return s}setTurn(e){return this._turn==e?!1:(this.move("--"),!0)}turn(){return this._turn}board(){let e=[],t=[];for(let s=E.a8;s<=E.h1;s++)this._board[s]==null?t.push(null):t.push({square:O(s),type:this._board[s].type,color:this._board[s].color}),s+1&136&&(e.push(t),t=[],s+=8);return e}squareColor(e){if(e in E){let t=E[e];return(re(t)+Se(t))%2===0?"light":"dark"}return null}history({verbose:e=!1}={}){let t=[],s=[];for(;this._history.length>0;)t.push(this._undoMove());for(;;){let i=t.pop();if(!i)break;e?s.push(new ce(this,i)):s.push(this._moveToSan(i,this._moves())),this._makeMove(i)}return s}_getPositionCount(e){return this._positionCount.get(e)??0}_incPositionCount(){this._positionCount.set(this._hash,(this._positionCount.get(this._hash)??0)+1)}_decPositionCount(e){let t=this._positionCount.get(e)??0;t===1?this._positionCount.delete(e):this._positionCount.set(e,t-1)}_pruneComments(){let e=[],t={},s=i=>{i in this._comments&&(t[i]=this._comments[i])};for(;this._history.length>0;)e.push(this._undoMove());for(s(this.fen());;){let i=e.pop();if(!i)break;this._makeMove(i),s(this.fen())}this._comments=t}getComment(){return this._comments[this.fen()]}setComment(e){this._comments[this.fen()]=e.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){let e=this._comments[this.fen()];return delete this._comments[this.fen()],e}getComments(){return this._pruneComments(),Object.keys(this._comments).map(e=>({fen:e,comment:this._comments[e]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(e=>{let t=this._comments[e];return delete this._comments[e],{fen:e,comment:t}})}setCastlingRights(e,t){for(let i of[A,J])t[i]!==void 0&&(t[i]?this._castling[e]|=$e[i]:this._castling[e]&=~$e[i]);this._updateCastlingRights();let s=this.getCastlingRights(e);return(t[A]===void 0||t[A]===s[A])&&(t[J]===void 0||t[J]===s[J])}getCastlingRights(e){return{[A]:(this._castling[e]&$e[A])!==0,[J]:(this._castling[e]&$e[J])!==0}}moveNumber(){return this._moveNumber}};window.AnkiChess={Chess:Ue,Chessboard:Me,Markers:Oe,MARKER_TYPE:se,Arrows:Le,ARROW_TYPE:Tt,PromotionDialog:De};console.log("AnkiChess Bundle con L\xF3gica (SAN) cargado v3.0");})();
/*! Bundled license information:

chess.js/dist/esm/chess.js:
  (**
   * @license
   * Copyright (c) 2025, Jeff Hlywa (jhlywa@gmail.com)
   * All rights reserved.
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions are met:
   *
   * 1. Redistributions of source code must retain the above copyright notice,
   *    this list of conditions and the following disclaimer.
   * 2. Redistributions in binary form must reproduce the above copyright notice,
   *    this list of conditions and the following disclaimer in the documentation
   *    and/or other materials provided with the distribution.
   *
   * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
   * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
   * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
   * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
   * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
   * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
   * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
   * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
   * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
   * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
   * POSSIBILITY OF SUCH DAMAGE.
   *)
*/
