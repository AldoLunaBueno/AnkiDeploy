(()=>{var q={start:"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",empty:"8/8/8/8/8/8/8/8"},u=class d{constructor(e=q.empty){this.squares=new Array(64).fill(null),this.setFen(e)}setFen(e=q.empty){let t=e.replace(/^\s*/,"").replace(/\s*$/,"").split(/\/|\s/);for(let s=0;s<8;s++){let i=t[7-s].replace(/\d/g,r=>{let o=parseInt(r),a="";for(let c=0;c<o;c++)a+="-";return a});for(let r=0;r<8;r++){let o=i.substring(r,r+1),a=null;o!=="-"&&(o.toUpperCase()===o?a=`w${o.toLowerCase()}`:a=`b${o}`),this.squares[s*8+r]=a}}}getFen(){let e=new Array(8).fill("");for(let t=0;t<8;t++){let s=0;for(let i=0;i<8;i++){let r=this.squares[t*8+i];if(!r)s++;else{s>0&&(e[7-t]+=s,s=0);let o=r.substring(0,1),a=r.substring(1,2);o==="w"?e[7-t]+=a.toUpperCase():e[7-t]+=a}}s>0&&(e[7-t]+=s,s=0)}return e.join("/")}getPieces(e=void 0,t=void 0,s=["k","q","r","b","n","p"]){let i=[],r=(o,a)=>s.indexOf(o.name)-s.indexOf(a.name);for(let o=0;o<64;o++){let a=this.squares[o];if(a){let c=a.charAt(1),f=a.charAt(0),b=d.indexToSquare(o);if(t&&t!==c||e&&e!==f)continue;i.push({name:c,type:c,color:f,position:b,square:b})}}return s&&i.sort(r),i}movePiece(e,t){if(!this.squares[d.squareToIndex(e)]){console.warn("no piece on",e);return}this.squares[d.squareToIndex(t)]=this.squares[d.squareToIndex(e)],this.squares[d.squareToIndex(e)]=null}setPiece(e,t){this.squares[d.squareToIndex(e)]=t}getPiece(e){return this.squares[d.squareToIndex(e)]}static squareToIndex(e){let t=d.squareToCoordinates(e);return t[0]+t[1]*8}static indexToSquare(e){return this.coordinatesToSquare([Math.floor(e%8),e/8])}static squareToCoordinates(e){let t=e.charCodeAt(0)-97,s=e.charCodeAt(1)-49;return[t,s]}static coordinatesToSquare(e){let t=String.fromCharCode(e[0]+97),s=String.fromCharCode(e[1]+49);return t+s}toString(){return this.getFen()}clone(){let e=new d;return e.squares=this.squares.slice(0),e}};var T=class{constructor(){this.position=new u,this.orientation=void 0,this.inputWhiteEnabled=!1,this.inputBlackEnabled=!1,this.squareSelectEnabled=!1,this.moveInputCallback=null,this.extensionPoints={},this.moveInputProcess=Promise.resolve()}inputEnabled(){return this.inputWhiteEnabled||this.inputBlackEnabled}invokeExtensionPoints(e,t={}){let s=this.extensionPoints[e],i=Object.assign({},t);i.extensionPoint=e;let r=!0;if(s)for(let o of s)o(i)===!1&&(r=!1);return r}};var Z="http://www.w3.org/2000/svg",h=class{static createSvg(e=void 0){let t=document.createElementNS(Z,"svg");return e&&(t.setAttribute("width","100%"),t.setAttribute("height","100%"),e.appendChild(t)),t}static addElement(e,t,s={}){let i=document.createElementNS(Z,t);t==="use"&&(s["xlink:href"]=s.href);for(let r in s)if(s.hasOwnProperty(r))if(r.indexOf(":")!==-1){let o=r.split(":");i.setAttributeNS("http://www.w3.org/1999/"+o[0],o[1],s[r])}else i.setAttribute(r,s[r]);return e.appendChild(i),i}static removeElement(e){if(!e){console.warn("removeElement, element is",e);return}e.parentNode?e.parentNode.removeChild(e):console.warn(e,"without parentNode")}};var l={positionChanged:"positionChanged",boardChanged:"boardChanged",moveInputToggled:"moveInputToggled",moveInput:"moveInput",beforeRedrawBoard:"beforeRedrawBoard",afterRedrawBoard:"afterRedrawBoard",redrawBoard:"redrawBoard",animation:"animation",destroy:"destroy"},S=class{constructor(e){this.chessboard=e}registerExtensionPoint(e,t){e===l.redrawBoard&&(console.warn("EXTENSION_POINT.redrawBoard is deprecated, use EXTENSION_POINT.afterRedrawBoard"),e=l.afterRedrawBoard),this.chessboard.state.extensionPoints[e]||(this.chessboard.state.extensionPoints[e]=[]),this.chessboard.state.extensionPoints[e].push(t)}registerMethod(e,t){console.warn("registerMethod is deprecated, just add methods directly to the chessboard instance"),this.chessboard[e]?log.error("method",e,"already exists"):this.chessboard[e]=(...s)=>t.apply(this,s)}};var p=class d{static delegate(e,t,s,i){let r=function(o){let a=o.target;for(;a&&a!==this;)a.matches(s)&&i.call(a,o),a=a.parentNode};return e.addEventListener(t,r),{remove:function(){e.removeEventListener(t,r)}}}static mergeObjects(e,t){let s=i=>i&&typeof i=="object";if(!s(e)||!s(t))return t;for(let i of Object.keys(t))t[i]instanceof Object&&Object.assign(t[i],d.mergeObjects(e[i],t[i]));return Object.assign(e||{},t),e}static createDomElement(e){let t=document.createElement("template");return t.innerHTML=e.trim(),t.content.firstChild}static createTask(){let e,t,s=new Promise(function(i,r){e=i,t=r});return s.resolve=e,s.reject=t,s}static isAbsoluteUrl(e){return e.indexOf("://")!==-1||e.startsWith("/")}};var N={start:"start",frame:"frame",end:"end"},G=class{constructor(){this.queue=[],this.workingOnPromise=!1,this.stop=!1}async enqueue(e){return new Promise((t,s)=>{this.queue.push({promise:e,resolve:t,reject:s}),this.dequeue()})}dequeue(){if(this.workingOnPromise)return;if(this.stop){this.queue=[],this.stop=!1;return}let e=this.queue.shift();if(e){try{this.workingOnPromise=!0,e.promise().then(t=>{this.workingOnPromise=!1,e.resolve(t),this.dequeue()}).catch(t=>{this.workingOnPromise=!1,e.reject(t),this.dequeue()})}catch(t){this.workingOnPromise=!1,e.reject(t),this.dequeue()}return!0}}destroy(){this.stop=!0}},w={move:0,appear:1,disappear:2},x=class d{constructor(e,t,s,i,r){this.view=e,t&&s?(this.animatedElements=this.createAnimation(t.squares,s.squares),this.duration=i,this.callback=r,this.frameHandle=requestAnimationFrame(this.animationStep.bind(this))):console.error("fromPosition",t,"toPosition",s),this.view.positionsAnimationTask=p.createTask(),this.view.chessboard.state.invokeExtensionPoints(l.animation,{type:N.start})}static seekChanges(e,t){let s=[],i=[],r=[];for(let o=0;o<64;o++){let a=e[o],c=t[o];c!==a&&(c&&s.push({piece:c,index:o}),a&&i.push({piece:a,index:o}))}return s.forEach(o=>{let a=8,c=null;i.forEach(f=>{if(o.piece===f.piece){let b=d.squareDistance(o.index,f.index);b<a&&(c=f,a=b)}}),c?(i.splice(i.indexOf(c),1),r.push({type:w.move,piece:o.piece,atIndex:c.index,toIndex:o.index})):r.push({type:w.appear,piece:o.piece,atIndex:o.index})}),i.forEach(o=>{r.push({type:w.disappear,piece:o.piece,atIndex:o.index})}),r}createAnimation(e,t){let s=d.seekChanges(e,t),i=[];return s.forEach(r=>{let o={type:r.type};switch(r.type){case w.move:o.element=this.view.getPieceElement(u.indexToSquare(r.atIndex)),o.element.parentNode.appendChild(o.element),o.atPoint=this.view.indexToPoint(r.atIndex),o.toPoint=this.view.indexToPoint(r.toIndex);break;case w.appear:o.element=this.view.drawPieceOnSquare(u.indexToSquare(r.atIndex),r.piece),o.element.style.opacity=0;break;case w.disappear:o.element=this.view.getPieceElement(u.indexToSquare(r.atIndex));break}i.push(o)}),i}animationStep(e){if(!this.view||!this.view.chessboard.state)return;this.startTime||(this.startTime=e);let t=e-this.startTime;if(t<=this.duration)this.frameHandle=requestAnimationFrame(this.animationStep.bind(this));else{cancelAnimationFrame(this.frameHandle),this.animatedElements.forEach(r=>{r.type===w.disappear&&h.removeElement(r.element)}),this.view.positionsAnimationTask.resolve(),this.view.chessboard.state.invokeExtensionPoints(l.animation,{type:N.end}),this.callback();return}let s=Math.min(1,t/this.duration),i=s<.5?2*s*s:-1+(4-2*s)*s;(isNaN(i)||i>.99)&&(i=1),this.animatedElements.forEach(r=>{if(r.element)switch(r.type){case w.move:r.element.transform.baseVal.removeItem(0);let o=this.view.svg.createSVGTransform();o.setTranslate(r.atPoint.x+(r.toPoint.x-r.atPoint.x)*i,r.atPoint.y+(r.toPoint.y-r.atPoint.y)*i),r.element.transform.baseVal.appendItem(o);break;case w.appear:r.element.style.opacity=Math.round(i*100)/100;break;case w.disappear:r.element.style.opacity=Math.round((1-i)*100)/100;break}else console.warn("animatedItem has no element",r)}),this.view.chessboard.state.invokeExtensionPoints(l.animation,{type:N.frame,progress:i})}static squareDistance(e,t){let s=e%8,i=Math.floor(e/8),r=t%8,o=Math.floor(t/8);return Math.max(Math.abs(o-i),Math.abs(r-s))}},C=class extends G{constructor(e){super(),this.chessboard=e}async enqueuePositionChange(e,t,s){return e.getFen()===t.getFen()?Promise.resolve():super.enqueue(()=>new Promise(i=>{let r=s?this.chessboard.props.style.animationDuration:0;this.queue.length>0&&(r=r/(1+Math.pow(this.queue.length/5,2))),new x(this.chessboard.view,e,t,s?r:0,()=>{this.chessboard.view&&this.chessboard.view.redrawPieces(t.squares),i()})}))}async enqueueTurnBoard(e,t,s){return super.enqueue(()=>new Promise(i=>{let r=new u(q.empty),o=s?this.chessboard.props.style.animationDuration:0;this.queue.length>0&&(o=o/(1+Math.pow(this.queue.length/5,2))),new x(this.chessboard.view,e,r,s?o:0,()=>{this.chessboard.state.orientation=t,this.chessboard.view.redrawBoard(),this.chessboard.view.redrawPieces(r.squares),new x(this.chessboard.view,r,e,s?o:0,()=>{this.chessboard.view.redrawPieces(e.squares),i()})})}))}};var n={waitForInputStart:"waitForInputStart",pieceClickedThreshold:"pieceClickedThreshold",clickTo:"clickTo",secondClickThreshold:"secondClickThreshold",dragTo:"dragTo",clickDragTo:"clickDragTo",moveDone:"moveDone",reset:"reset"},I={secondClick:"secondClick",secondaryClick:"secondaryClick",movedOutOfBoard:"movedOutOfBoard",draggedBack:"draggedBack",clickedAnotherPiece:"clickedAnotherPiece"},ee=4,M=class{constructor(e){this.view=e,this.chessboard=e.chessboard,this.moveInputState=null,this.fromSquare=null,this.toSquare=null,this.setMoveInputState(n.waitForInputStart)}moveInputStartedCallback(e){let t=this.view.moveInputStartedCallback(e);return t&&(this.chessboard.state.moveInputProcess=p.createTask(),this.chessboard.state.moveInputProcess.then(s=>{(this.moveInputState===n.waitForInputStart||this.moveInputState===n.moveDone)&&this.view.moveInputFinishedCallback(this.fromSquare,this.toSquare,s)})),t}movingOverSquareCallback(e,t){this.view.movingOverSquareCallback(e,t)}validateMoveInputCallback(e,t){let s=this.view.validateMoveInputCallback(e,t);return this.chessboard.state.moveInputProcess.resolve(s),s}moveInputCanceledCallback(e,t,s){this.view.moveInputCanceledCallback(e,t,s),this.chessboard.state.moveInputProcess.resolve()}setMoveInputState(e,t=void 0){let s=this.moveInputState;switch(this.moveInputState=e,e){case n.waitForInputStart:break;case n.pieceClickedThreshold:if(n.waitForInputStart!==s&&n.clickTo!==s)throw new Error("moveInputState");if(this.pointerMoveListener&&(removeEventListener(this.pointerMoveListener.type,this.pointerMoveListener),this.pointerMoveListener=null),this.pointerUpListener&&(removeEventListener(this.pointerUpListener.type,this.pointerUpListener),this.pointerUpListener=null),this.fromSquare=t.square,this.toSquare=null,this.movedPiece=t.piece,this.startPoint=t.point,!this.pointerMoveListener&&!this.pointerUpListener){if(t.type==="mousedown")this.pointerMoveListener=this.onPointerMove.bind(this),this.pointerMoveListener.type="mousemove",addEventListener("mousemove",this.pointerMoveListener),this.pointerUpListener=this.onPointerUp.bind(this),this.pointerUpListener.type="mouseup",addEventListener("mouseup",this.pointerUpListener);else if(t.type==="touchstart")this.pointerMoveListener=this.onPointerMove.bind(this),this.pointerMoveListener.type="touchmove",addEventListener("touchmove",this.pointerMoveListener),this.pointerUpListener=this.onPointerUp.bind(this),this.pointerUpListener.type="touchend",addEventListener("touchend",this.pointerUpListener);else throw Error("4b74af");this.contextMenuListener||(this.contextMenuListener=this.onContextMenu.bind(this),this.chessboard.view.svg.addEventListener("contextmenu",this.contextMenuListener))}else throw Error("94ad0c");break;case n.clickTo:this.draggablePiece&&(h.removeElement(this.draggablePiece),this.draggablePiece=null),s===n.dragTo&&this.view.setPieceVisibility(t.square,!0);break;case n.secondClickThreshold:if(n.clickTo!==s)throw new Error("moveInputState");this.startPoint=t.point;break;case n.dragTo:if(n.pieceClickedThreshold!==s)throw new Error("moveInputState");this.view.chessboard.state.inputEnabled()&&(this.view.setPieceVisibility(t.square,!1),this.createDraggablePiece(t.piece));break;case n.clickDragTo:if(n.secondClickThreshold!==s)throw new Error("moveInputState");this.view.chessboard.state.inputEnabled()&&(this.view.setPieceVisibility(t.square,!1),this.createDraggablePiece(t.piece));break;case n.moveDone:if([n.dragTo,n.clickTo,n.clickDragTo].indexOf(s)===-1)throw new Error("moveInputState");this.toSquare=t.square,this.toSquare&&this.validateMoveInputCallback(this.fromSquare,this.toSquare)?this.chessboard.movePiece(this.fromSquare,this.toSquare,s===n.clickTo).then(()=>{s===n.clickTo&&this.view.setPieceVisibility(this.toSquare,!0),this.setMoveInputState(n.reset)}):(this.view.setPieceVisibility(this.fromSquare,!0),this.setMoveInputState(n.reset));break;case n.reset:this.fromSquare&&!this.toSquare&&this.movedPiece&&this.chessboard.state.position.setPiece(this.fromSquare,this.movedPiece),this.fromSquare=null,this.toSquare=null,this.movedPiece=null,this.draggablePiece&&(h.removeElement(this.draggablePiece),this.draggablePiece=null),this.pointerMoveListener&&(removeEventListener(this.pointerMoveListener.type,this.pointerMoveListener),this.pointerMoveListener=null),this.pointerUpListener&&(removeEventListener(this.pointerUpListener.type,this.pointerUpListener),this.pointerUpListener=null),this.contextMenuListener&&(removeEventListener("contextmenu",this.contextMenuListener),this.contextMenuListener=null),this.setMoveInputState(n.waitForInputStart);let i=this.view.piecesGroup.querySelectorAll("[visibility=hidden]");for(let r=0;r<i.length;r++)i[r].removeAttribute("visibility");break;default:throw Error(`260b09: moveInputState ${e}`)}}createDraggablePiece(e){if(this.draggablePiece)throw Error("draggablePiece already exists");this.draggablePiece=h.createSvg(document.body),this.draggablePiece.classList.add("cm-chessboard-draggable-piece"),this.draggablePiece.setAttribute("width",this.view.squareWidth),this.draggablePiece.setAttribute("height",this.view.squareHeight),this.draggablePiece.setAttribute("style","pointer-events: none"),this.draggablePiece.name=e;let t=this.chessboard.props.assetsCache?"":this.view.getSpriteUrl(),s=h.addElement(this.draggablePiece,"use",{href:`${t}#${e}`}),i=this.view.squareHeight/this.chessboard.props.style.pieces.tileSize,r=this.draggablePiece.createSVGTransform();r.setScale(i,i),s.transform.baseVal.appendItem(r)}moveDraggablePiece(e,t){this.draggablePiece.setAttribute("style",`pointer-events: none; position: absolute; left: ${e-this.view.squareHeight/2}px; top: ${t-this.view.squareHeight/2}px`)}onPointerDown(e){if(!(e.type==="mousedown"&&e.button===0||e.type==="touchstart"))return;let t=e.target.getAttribute("data-square");if(!t)return;let s=this.chessboard.getPiece(t),i;if(s&&(i=s?s.substring(0,1):null,(i==="w"&&this.chessboard.state.inputWhiteEnabled||i==="b"&&this.chessboard.state.inputBlackEnabled)&&e.preventDefault()),this.moveInputState!==n.waitForInputStart||this.chessboard.state.inputWhiteEnabled&&i==="w"||this.chessboard.state.inputBlackEnabled&&i==="b"){let r;if(e.type==="mousedown"?r={x:e.clientX,y:e.clientY}:e.type==="touchstart"&&(r={x:e.touches[0].clientX,y:e.touches[0].clientY}),this.moveInputState===n.waitForInputStart&&s&&this.moveInputStartedCallback(t))this.setMoveInputState(n.pieceClickedThreshold,{square:t,piece:s,point:r,type:e.type});else if(this.moveInputState===n.clickTo)if(t===this.fromSquare)this.setMoveInputState(n.secondClickThreshold,{square:t,piece:s,point:r,type:e.type});else{let o=this.chessboard.getPiece(t),a=o?o.substring(0,1):null,c=this.chessboard.getPiece(this.fromSquare),f=c?c.substring(0,1):null;i&&f===a?this.validateMoveInputCallback(this.fromSquare,t)||(this.moveInputCanceledCallback(this.fromSquare,t,I.clickedAnotherPiece),this.moveInputStartedCallback(t)?this.setMoveInputState(n.pieceClickedThreshold,{square:t,piece:o,point:r,type:e.type}):this.setMoveInputState(n.reset)):this.setMoveInputState(n.moveDone,{square:t})}}}onPointerMove(e){let t,s,i,r,o;if(e.type==="mousemove"?(i=e.clientX,r=e.clientY,t=e.pageX,s=e.pageY,o=e.target):e.type==="touchmove"&&(i=e.touches[0].clientX,r=e.touches[0].clientY,t=e.touches[0].pageX,s=e.touches[0].pageY,o=document.elementFromPoint(i,r)),this.moveInputState===n.pieceClickedThreshold||this.moveInputState===n.secondClickThreshold)(Math.abs(this.startPoint.x-i)>ee||Math.abs(this.startPoint.y-r)>ee)&&(this.moveInputState===n.secondClickThreshold?this.setMoveInputState(n.clickDragTo,{square:this.fromSquare,piece:this.movedPiece}):this.setMoveInputState(n.dragTo,{square:this.fromSquare,piece:this.movedPiece}),this.view.chessboard.state.inputEnabled()&&this.moveDraggablePiece(t,s));else if(this.moveInputState===n.dragTo||this.moveInputState===n.clickDragTo||this.moveInputState===n.clickTo){if(o&&o.getAttribute&&o.parentElement===this.view.boardGroup){let a=o.getAttribute("data-square");a!==this.fromSquare&&a!==this.toSquare?(this.toSquare=a,this.movingOverSquareCallback(this.fromSquare,this.toSquare)):a===this.fromSquare&&this.toSquare!==null&&(this.toSquare=null,this.movingOverSquareCallback(this.fromSquare,null))}else this.toSquare!==null&&(this.toSquare=null,this.movingOverSquareCallback(this.fromSquare,null));this.view.chessboard.state.inputEnabled()&&(this.moveInputState===n.dragTo||this.moveInputState===n.clickDragTo)&&this.moveDraggablePiece(t,s)}}onPointerUp(e){let t;if(e.type==="mouseup"?t=e.target:e.type==="touchend"&&(t=document.elementFromPoint(e.changedTouches[0].clientX,e.changedTouches[0].clientY)),t&&t.getAttribute){let s=t.getAttribute("data-square");if(s)this.moveInputState===n.dragTo||this.moveInputState===n.clickDragTo?this.fromSquare===s?this.moveInputState===n.clickDragTo?(this.chessboard.state.position.setPiece(this.fromSquare,this.movedPiece),this.view.setPieceVisibility(this.fromSquare),this.moveInputCanceledCallback(s,null,I.draggedBack),this.setMoveInputState(n.reset)):this.setMoveInputState(n.clickTo,{square:s}):this.setMoveInputState(n.moveDone,{square:s}):this.moveInputState===n.pieceClickedThreshold?this.setMoveInputState(n.clickTo,{square:s}):this.moveInputState===n.secondClickThreshold&&(this.setMoveInputState(n.reset),this.moveInputCanceledCallback(s,null,I.secondClick));else{this.view.redrawPieces();let i=this.fromSquare;this.setMoveInputState(n.reset),this.moveInputCanceledCallback(i,null,I.movedOutOfBoard)}}else this.view.redrawPieces(),this.setMoveInputState(n.reset)}onContextMenu(e){e.preventDefault(),this.view.redrawPieces(),this.setMoveInputState(n.reset),this.moveInputCanceledCallback(this.fromSquare,null,I.secondaryClick)}isDragging(){return this.moveInputState===n.dragTo||this.moveInputState===n.clickDragTo}destroy(){this.setMoveInputState(n.reset)}};var v={white:"w",black:"b"},g={moveInputStarted:"moveInputStarted",movingOverSquare:"movingOverSquare",validateMoveInput:"validateMoveInput",moveInputCanceled:"moveInputCanceled",moveInputFinished:"moveInputFinished"},te={pointercancel:"pointercancel",pointerdown:"pointerdown",pointerenter:"pointerenter",pointerleave:"pointerleave",pointermove:"pointermove",pointerout:"pointerout",pointerover:"pointerover",pointerup:"pointerup"},P={none:"none",thin:"thin",frame:"frame"},A=class{constructor(e){this.chessboard=e,this.visualMoveInput=new M(this),e.props.assetsCache&&this.cacheSpriteToDiv("cm-chessboard-sprite",this.getSpriteUrl()),this.container=document.createElement("div"),this.chessboard.context.appendChild(this.container),e.props.responsive&&(typeof ResizeObserver<"u"?(this.resizeObserver=new ResizeObserver(()=>{setTimeout(()=>{this.handleResize()})}),this.resizeObserver.observe(this.chessboard.context)):(this.resizeListener=this.handleResize.bind(this),window.addEventListener("resize",this.resizeListener))),this.positionsAnimationTask=Promise.resolve(),this.pointerDownListener=this.pointerDownHandler.bind(this),this.container.addEventListener("mousedown",this.pointerDownListener),this.container.addEventListener("touchstart",this.pointerDownListener,{passive:!1}),this.createSvgAndGroups(),this.handleResize()}pointerDownHandler(e){this.visualMoveInput.onPointerDown(e)}destroy(){this.visualMoveInput.destroy(),this.resizeObserver&&this.resizeObserver.unobserve(this.chessboard.context),this.resizeListener&&window.removeEventListener("resize",this.resizeListener),this.chessboard.context.removeEventListener("mousedown",this.pointerDownListener),this.chessboard.context.removeEventListener("touchstart",this.pointerDownListener),h.removeElement(this.svg),this.container.remove()}cacheSpriteToDiv(e,t){if(!document.getElementById(e)){let s=document.createElement("div");s.style.transform="scale(0)",s.style.position="absolute",s.setAttribute("aria-hidden","true"),s.id=e,document.body.appendChild(s);let i=new XMLHttpRequest;i.open("GET",t,!0),i.onload=function(){s.insertAdjacentHTML("afterbegin",i.response)},i.send()}}createSvgAndGroups(){this.svg=h.createSvg(this.container);let e=this.chessboard.props.style.cssClass?this.chessboard.props.style.cssClass:"default";this.svg.setAttribute("class","cm-chessboard border-type-"+this.chessboard.props.style.borderType+" "+e),this.svg.setAttribute("role","img"),this.updateMetrics(),this.boardGroup=h.addElement(this.svg,"g",{class:"board"}),this.coordinatesGroup=h.addElement(this.svg,"g",{class:"coordinates","aria-hidden":"true"}),this.markersLayer=h.addElement(this.svg,"g",{class:"markers-layer"}),this.piecesLayer=h.addElement(this.svg,"g",{class:"pieces-layer"}),this.piecesGroup=h.addElement(this.piecesLayer,"g",{class:"pieces"}),this.markersTopLayer=h.addElement(this.svg,"g",{class:"markers-top-layer"}),this.interactiveTopLayer=h.addElement(this.svg,"g",{class:"interactive-top-layer"})}updateMetrics(){let e=this.chessboard.props.style.pieces.tileSize;this.width=this.container.clientWidth,this.height=this.container.clientWidth*(this.chessboard.props.style.aspectRatio||1),this.chessboard.props.style.borderType===P.frame?this.borderSize=this.width/25:this.chessboard.props.style.borderType===P.thin?this.borderSize=this.width/320:this.borderSize=0,this.innerWidth=this.width-2*this.borderSize,this.innerHeight=this.height-2*this.borderSize,this.squareWidth=this.innerWidth/8,this.squareHeight=this.innerHeight/8,this.scalingX=this.squareWidth/e,this.scalingY=this.squareHeight/e,this.pieceXTranslate=this.squareWidth/2-e*this.scalingY/2}handleResize(){this.container.style.width=this.chessboard.context.clientWidth+"px",this.container.style.height=this.chessboard.context.clientWidth*this.chessboard.props.style.aspectRatio+"px",(this.container.clientWidth!==this.width||this.container.clientHeight!==this.height)&&(this.updateMetrics(),this.redrawBoard(),this.redrawPieces()),this.svg.setAttribute("width","100%"),this.svg.setAttribute("height","100%")}redrawBoard(){this.chessboard.state.invokeExtensionPoints(l.beforeRedrawBoard),this.redrawSquares(),this.drawCoordinates(),this.chessboard.state.invokeExtensionPoints(l.afterRedrawBoard),this.visualizeInputState()}redrawSquares(){for(;this.boardGroup.firstChild;)this.boardGroup.removeChild(this.boardGroup.lastChild);if(h.addElement(this.boardGroup,"rect",{width:this.width,height:this.height}).setAttribute("class","border"),this.chessboard.props.style.borderType===P.frame){let t=this.borderSize;h.addElement(this.boardGroup,"rect",{x:t,y:t,width:this.width-t*2,height:this.height-t*2}).setAttribute("class","border-inner")}for(let t=0;t<64;t++){let s=this.chessboard.state.orientation===v.white?t:63-t,r=`square ${(9*s&8)===0?"black":"white"}`,o=this.squareToPoint(u.indexToSquare(s)),a=h.addElement(this.boardGroup,"rect",{x:o.x,y:o.y,width:this.squareWidth,height:this.squareHeight});a.setAttribute("class",r),a.setAttribute("data-square",u.indexToSquare(s))}}drawCoordinates(){if(!this.chessboard.props.style.showCoordinates)return;for(;this.coordinatesGroup.firstChild;)this.coordinatesGroup.removeChild(this.coordinatesGroup.lastChild);let e=this.chessboard.props.style.borderType!==P.frame;for(let t=0;t<8;t++){let s=this.borderSize+(17+this.chessboard.props.style.pieces.tileSize*t)*this.scalingX,i=this.height-this.scalingY*3.5,r="coordinate file";e&&(s=s+this.scalingX*15.5,r+=t%2?" white":" black");let o=h.addElement(this.coordinatesGroup,"text",{class:r,x:s,y:i,style:`font-size: ${this.scalingY*10}px`});this.chessboard.state.orientation===v.white?o.textContent=String.fromCharCode(97+t):o.textContent=String.fromCharCode(104-t)}for(let t=0;t<8;t++){let s=this.borderSize/3.7,i=this.borderSize+25*this.scalingY+t*this.squareHeight,r="coordinate rank";e&&(r+=t%2?" black":" white",this.chessboard.props.style.borderType===P.frame?(s=s+this.scalingX*10,i=i-this.scalingY*15):(s=s+this.scalingX*2,i=i-this.scalingY*15));let o=h.addElement(this.coordinatesGroup,"text",{class:r,x:s,y:i,style:`font-size: ${this.scalingY*10}px`});this.chessboard.state.orientation===v.white?o.textContent=""+(8-t):o.textContent=""+(1+t)}}redrawPieces(e=this.chessboard.state.position.squares){let t=Array.from(this.piecesGroup.childNodes),s=this.visualMoveInput.isDragging();for(let i=0;i<64;i++){let r=e[i];if(r){let o=u.indexToSquare(i);this.drawPieceOnSquare(o,r,s&&o===this.visualMoveInput.fromSquare)}}for(let i of t)this.piecesGroup.removeChild(i)}drawPiece(e,t,s){let i=h.addElement(e,"g",{});i.setAttribute("data-piece",t);let r=this.svg.createSVGTransform();r.setTranslate(s.x,s.y),i.transform.baseVal.appendItem(r);let o=this.chessboard.props.assetsCache?"":this.getSpriteUrl(),a=h.addElement(i,"use",{href:`${o}#${t}`,class:"piece"}),c=this.svg.createSVGTransform();return c.setScale(this.scalingY,this.scalingY),a.transform.baseVal.appendItem(c),i}drawPieceOnSquare(e,t,s=!1){let i=h.addElement(this.piecesGroup,"g",{});i.setAttribute("data-piece",t),i.setAttribute("data-square",e),s&&i.setAttribute("visibility","hidden");let r=this.squareToPoint(e),o=this.svg.createSVGTransform();o.setTranslate(r.x,r.y),i.transform.baseVal.appendItem(o);let a=this.chessboard.props.assetsCache?"":this.getSpriteUrl(),c=h.addElement(i,"use",{href:`${a}#${t}`,class:"piece"}),f=this.svg.createSVGTransform();f.setTranslate(this.pieceXTranslate,0),c.transform.baseVal.appendItem(f);let b=this.svg.createSVGTransform();return b.setScale(this.scalingY,this.scalingY),c.transform.baseVal.appendItem(b),i}setPieceVisibility(e,t=!0){let s=this.getPieceElement(e);s?t?s.setAttribute("visibility","visible"):s.setAttribute("visibility","hidden"):console.warn("no piece on",e)}getPieceElement(e){if(!e||e.length<2)return console.warn("invalid square",e),null;let t=this.piecesGroup.querySelector(`g[data-square='${e}']`);return t||(console.warn("no piece on",e),null)}enableMoveInput(e,t=null){if(this.chessboard.state.moveInputCallback)throw Error("moveInput already enabled");t===v.white?this.chessboard.state.inputWhiteEnabled=!0:t===v.black?this.chessboard.state.inputBlackEnabled=!0:(this.chessboard.state.inputWhiteEnabled=!0,this.chessboard.state.inputBlackEnabled=!0),this.chessboard.state.moveInputCallback=e,this.chessboard.state.invokeExtensionPoints(l.moveInputToggled,{enabled:!0,color:t}),this.visualizeInputState()}disableMoveInput(){this.chessboard.state.inputWhiteEnabled=!1,this.chessboard.state.inputBlackEnabled=!1,this.chessboard.state.moveInputCallback=null,this.chessboard.state.invokeExtensionPoints(l.moveInputToggled,{enabled:!1}),this.visualizeInputState()}moveInputStartedCallback(e){let t={chessboard:this.chessboard,type:g.moveInputStarted,square:e,squareFrom:e,piece:this.chessboard.getPiece(e)};return this.chessboard.state.moveInputCallback&&(t.moveInputCallbackResult=this.chessboard.state.moveInputCallback(t)),this.chessboard.state.invokeExtensionPoints(l.moveInput,t),t.moveInputCallbackResult}movingOverSquareCallback(e,t){let s={chessboard:this.chessboard,type:g.movingOverSquare,squareFrom:e,squareTo:t,piece:this.chessboard.getPiece(e)};this.chessboard.state.moveInputCallback&&(s.moveInputCallbackResult=this.chessboard.state.moveInputCallback(s)),this.chessboard.state.invokeExtensionPoints(l.moveInput,s)}validateMoveInputCallback(e,t){let s={chessboard:this.chessboard,type:g.validateMoveInput,squareFrom:e,squareTo:t,piece:this.chessboard.getPiece(e)};return this.chessboard.state.moveInputCallback&&(s.moveInputCallbackResult=this.chessboard.state.moveInputCallback(s)),this.chessboard.state.invokeExtensionPoints(l.moveInput,s),s.moveInputCallbackResult}moveInputCanceledCallback(e,t,s){let i={chessboard:this.chessboard,type:g.moveInputCanceled,reason:s,squareFrom:e,squareTo:t};this.chessboard.state.moveInputCallback&&this.chessboard.state.moveInputCallback(i),this.chessboard.state.invokeExtensionPoints(l.moveInput,i)}moveInputFinishedCallback(e,t,s){let i={chessboard:this.chessboard,type:g.moveInputFinished,squareFrom:e,squareTo:t,legalMove:s};this.chessboard.state.moveInputCallback&&this.chessboard.state.moveInputCallback(i),this.chessboard.state.invokeExtensionPoints(l.moveInput,i)}visualizeInputState(){this.chessboard.state&&(this.chessboard.state.inputWhiteEnabled||this.chessboard.state.inputBlackEnabled?this.boardGroup.setAttribute("class","board input-enabled"):this.boardGroup.setAttribute("class","board"))}indexToPoint(e){let t,s;return this.chessboard.state.orientation===v.white?(t=this.borderSize+e%8*this.squareWidth,s=this.borderSize+(7-Math.floor(e/8))*this.squareHeight):(t=this.borderSize+(7-e%8)*this.squareWidth,s=this.borderSize+Math.floor(e/8)*this.squareHeight),{x:t,y:s}}squareToPoint(e){let t=u.squareToIndex(e);return this.indexToPoint(t)}getSpriteUrl(){return p.isAbsoluteUrl(this.chessboard.props.style.pieces.file)?this.chessboard.props.style.pieces.file:this.chessboard.props.assetsUrl+this.chessboard.props.style.pieces.file}};var k={wp:"wp",wb:"wb",wn:"wn",wr:"wr",wq:"wq",wk:"wk",bp:"bp",bb:"bb",bn:"bn",br:"br",bq:"bq",bk:"bk"};var he={svgSprite:"svgSprite"};var D=class{constructor(e,t={}){if(!e)throw new Error("container element is "+e);this.context=e,this.id=(Math.random()+1).toString(36).substring(2,8),this.extensions=[],this.props={position:q.empty,orientation:v.white,responsive:!0,assetsUrl:"./assets/",assetsCache:!0,style:{cssClass:"default",showCoordinates:!0,borderType:P.none,aspectRatio:1,pieces:{type:he.svgSprite,file:"pieces/standard.svg",tileSize:40},animationDuration:300},extensions:[]},p.mergeObjects(this.props,t),this.state=new T,this.view=new A(this),this.positionAnimationsQueue=new C(this),this.state.orientation=this.props.orientation;for(let s of this.props.extensions)this.addExtension(s.class,s.props);this.view.redrawBoard(),this.state.position=new u(this.props.position),this.view.redrawPieces(),this.state.invokeExtensionPoints(l.positionChanged),this.initialized=Promise.resolve()}async setPiece(e,t,s=!1){let i=this.state.position.clone();return this.state.position.setPiece(e,t),this.state.invokeExtensionPoints(l.positionChanged),this.positionAnimationsQueue.enqueuePositionChange(i,this.state.position.clone(),s)}async movePiece(e,t,s=!1){let i=this.state.position.clone();return this.state.position.movePiece(e,t),this.state.invokeExtensionPoints(l.positionChanged),this.positionAnimationsQueue.enqueuePositionChange(i,this.state.position.clone(),s)}async setPosition(e,t=!1){let s=this.state.position.clone(),i=new u(e);return s.getFen()!==i.getFen()&&(this.state.position.setFen(e),this.state.invokeExtensionPoints(l.positionChanged)),this.positionAnimationsQueue.enqueuePositionChange(s,this.state.position.clone(),t)}async setOrientation(e,t=!1){let s=this.state.position.clone();if(this.boardTurning){console.warn("setOrientation is only once in queue allowed");return}return this.boardTurning=!0,this.positionAnimationsQueue.enqueueTurnBoard(s,e,t).then(()=>{this.boardTurning=!1,this.state.invokeExtensionPoints(l.boardChanged)})}getPiece(e){return this.state.position.getPiece(e)}getPosition(){return this.state.position.getFen()}getOrientation(){return this.state.orientation}enableMoveInput(e,t=void 0){this.view.enableMoveInput(e,t)}disableMoveInput(){this.view.disableMoveInput()}isMoveInputEnabled(){return this.state.inputWhiteEnabled||this.state.inputBlackEnabled}enableSquareSelect(e=te.pointerdown,t){this.squareSelectListener||(this.squareSelectListener=function(s){let i=s.target.getAttribute("data-square");t({eventType:s.type,event:s,chessboard:this,square:i})}),this.context.addEventListener(e,this.squareSelectListener),this.state.squareSelectEnabled=!0,this.view.visualizeInputState()}disableSquareSelect(e){this.context.removeEventListener(e,this.squareSelectListener),this.squareSelectListener=void 0,this.state.squareSelectEnabled=!1,this.view.visualizeInputState()}isSquareSelectEnabled(){return this.state.squareSelectEnabled}addExtension(e,t){if(this.getExtension(e))throw Error('extension "'+e.name+'" already added');this.extensions.push(new e(this,t))}getExtension(e){for(let t of this.extensions)if(t instanceof e)return t;return null}destroy(){this.state.invokeExtensionPoints(l.destroy),this.positionAnimationsQueue.destroy(),this.view.destroy(),this.view=void 0,this.state=void 0}};var E={frame:{class:"marker-frame",slice:"markerFrame"},framePrimary:{class:"marker-frame-primary",slice:"markerFrame"},frameDanger:{class:"marker-frame-danger",slice:"markerFrame"},circle:{class:"marker-circle",slice:"markerCircle"},circlePrimary:{class:"marker-circle-primary",slice:"markerCircle"},circleDanger:{class:"marker-circle-danger",slice:"markerCircle"},circleDangerFilled:{class:"marker-circle-danger-filled",slice:"markerCircleFilled"},square:{class:"marker-square",slice:"markerSquare"},dot:{class:"marker-dot",slice:"markerDot",position:"above"},bevel:{class:"marker-bevel",slice:"markerBevel"}},L=class extends S{constructor(e,t={}){super(e),this.registerExtensionPoint(l.afterRedrawBoard,()=>{this.onRedrawBoard()}),this.props={autoMarkers:E.frame,sprite:"extensions/markers/markers.svg"},Object.assign(this.props,t),e.props.assetsCache&&e.view.cacheSpriteToDiv("cm-chessboard-markers",this.getSpriteUrl()),e.addMarker=this.addMarker.bind(this),e.getMarkers=this.getMarkers.bind(this),e.removeMarkers=this.removeMarkers.bind(this),e.addLegalMovesMarkers=this.addLegalMovesMarkers.bind(this),e.removeLegalMovesMarkers=this.removeLegalMovesMarkers.bind(this),this.markerGroupDown=h.addElement(e.view.markersLayer,"g",{class:"markers"}),this.markerGroupUp=h.addElement(e.view.markersTopLayer,"g",{class:"markers"}),this.markers=[],this.props.autoMarkers&&(Object.assign(this.props.autoMarkers,this.props.autoMarkers),this.registerExtensionPoint(l.moveInput,s=>{this.drawAutoMarkers(s)}))}drawAutoMarkers(e){e.type!==g.moveInputFinished&&this.removeMarkers(this.props.autoMarkers),!(e.type===g.moveInputStarted&&!e.moveInputCallbackResult)&&(e.type===g.moveInputStarted||e.type===g.movingOverSquare)&&(e.squareFrom&&this.addMarker(this.props.autoMarkers,e.squareFrom),e.squareTo&&this.addMarker(this.props.autoMarkers,e.squareTo))}onRedrawBoard(){for(;this.markerGroupUp.firstChild;)this.markerGroupUp.removeChild(this.markerGroupUp.firstChild);for(;this.markerGroupDown.firstChild;)this.markerGroupDown.removeChild(this.markerGroupDown.firstChild);this.markers.forEach(e=>{this.drawMarker(e)})}addLegalMovesMarkers(e){for(let t of e)t.promotion&&t.promotion!=="q"||(this.chessboard.getPiece(t.to)?this.chessboard.addMarker(E.bevel,t.to):this.chessboard.addMarker(E.dot,t.to))}removeLegalMovesMarkers(){this.chessboard.removeMarkers(E.bevel),this.chessboard.removeMarkers(E.dot)}drawMarker(e){let t;e.type.position==="above"?t=h.addElement(this.markerGroupUp,"g"):t=h.addElement(this.markerGroupDown,"g"),t.setAttribute("data-square",e.square);let s=this.chessboard.view.squareToPoint(e.square),i=this.chessboard.view.svg.createSVGTransform();i.setTranslate(s.x,s.y),t.transform.baseVal.appendItem(i);let r=this.chessboard.props.assetsCache?"":this.getSpriteUrl(),o=h.addElement(t,"use",{href:`${r}#${e.type.slice}`,class:"marker "+e.type.class}),a=this.chessboard.view.svg.createSVGTransform();return a.setScale(this.chessboard.view.scalingX,this.chessboard.view.scalingY),o.transform.baseVal.appendItem(a),t}addMarker(e,t){if(typeof e=="string"||typeof t=="object"){console.error("changed the signature of `addMarker` to `(type, square)` with v5.1.x");return}this.markers.push(new U(t,e)),this.onRedrawBoard()}getMarkers(e=void 0,t=void 0){if(typeof e=="string"||typeof t=="object"){console.error("changed the signature of `getMarkers` to `(type, square)` with v5.1.x");return}let s=[];return this.markers.forEach(i=>{i.matches(t,e)&&s.push(i)}),s}removeMarkers(e=void 0,t=void 0){if(typeof e=="string"||typeof t=="object"){console.error("changed the signature of `removeMarkers` to `(type, square)` with v5.1.x");return}this.markers=this.markers.filter(s=>!s.matches(t,e)),this.onRedrawBoard()}getSpriteUrl(){return p.isAbsoluteUrl(this.props.sprite)?this.props.sprite:this.chessboard.props.assetsUrl+this.props.sprite}},U=class{constructor(e,t){this.square=e,this.type=t}matches(e=void 0,t=void 0){if(!t&&!e)return!0;if(t){if(e){if(this.type===t&&e===this.square)return!0}else if(this.type===t)return!0}else if(e===this.square)return!0;return!1}};var O=class extends S{constructor(e,t={}){super(e),this.registerExtensionPoint(l.afterRedrawBoard,()=>{this.onRedrawBoard()}),this.props={sprite:"extensions/arrows/arrows.svg",slice:"arrowDefault",headSize:7,offsetFrom:0,offsetTo:.55},Object.assign(this.props,t),this.chessboard.props.assetsCache&&this.chessboard.view.cacheSpriteToDiv("cm-chessboard-arrows",this.getSpriteUrl()),e.addArrow=this.addArrow.bind(this),e.getArrows=this.getArrows.bind(this),e.removeArrows=this.removeArrows.bind(this),this.arrowGroup=h.addElement(e.view.markersTopLayer,"g",{class:"arrows"}),this.arrows=[]}onRedrawBoard(){for(;this.arrowGroup.firstChild;)this.arrowGroup.removeChild(this.arrowGroup.firstChild);this.arrows.forEach(e=>{this.drawArrow(e)})}drawArrow(e){let t=this.chessboard.view,s=h.addElement(this.arrowGroup,"g");s.setAttribute("data-arrow",e.from+e.to),s.setAttribute("class","arrow "+e.type.class);let i=t.squareToPoint(e.from),r=t.squareToPoint(e.to),o=this.chessboard.props.assetsCache?"":this.getSpriteUrl(),a=h.addElement(s,"defs"),c="arrow-"+e.from+e.to,f=h.addElement(a,"marker",{id:c,markerWidth:this.props.headSize,markerHeight:this.props.headSize,refX:20,refY:20,viewBox:"0 0 40 40",orient:"auto",class:"arrow-head"});h.addElement(f,"use",{href:`${o}#${this.props.slice}`});let b=i.x+t.squareWidth/2,z=i.y+t.squareHeight/2,Y=r.x+t.squareWidth/2,V=r.y+t.squareHeight/2,W=Y-b,H=V-z,X=Math.hypot(W,H)||1,_=W/X,j=H/X,$=Math.min(t.squareWidth,t.squareHeight)/2,K=ne=>Math.max(0,Math.min(1,ne)),Q=$*K(this.props.offsetFrom),J=$*K(this.props.offsetTo),se=b+_*Q,ie=z+j*Q,re=Y-_*J,oe=V-j*J,ae=(t.scalingX+t.scalingY)/2*8,y=h.addElement(s,"line");y.setAttribute("x1",se.toString()),y.setAttribute("x2",re.toString()),y.setAttribute("y1",ie.toString()),y.setAttribute("y2",oe.toString()),y.setAttribute("class","arrow-line"),y.setAttribute("marker-end","url(#"+c+")"),y.setAttribute("stroke-width",ae+"px")}addArrow(e,t,s){this.arrows.push(new F(t,s,e)),this.chessboard.view.redrawBoard()}getArrows(e=void 0,t=void 0,s=void 0){let i=[];return this.arrows.forEach(r=>{r.matches(t,s,e)&&i.push(r)}),i}removeArrows(e=void 0,t=void 0,s=void 0){this.arrows=this.arrows.filter(i=>!i.matches(t,s,e)),this.chessboard.view.redrawBoard()}getSpriteUrl(){return p.isAbsoluteUrl(this.props.sprite)?this.props.sprite:this.chessboard.props.assetsUrl+this.props.sprite}},F=class{constructor(e,t,s){this.from=e,this.to=t,this.type=s}matches(e=void 0,t=void 0,s=void 0){return e&&e!==this.from||t&&t!==this.to?!1:!(s&&s!==this.type)}};var m={hidden:"hidden",displayRequested:"displayRequested",shown:"shown"},ce={de:{choosePromotion:"Bauernumwandlung w\xE4hlen",promotionDialogTitle:"Bauernumwandlung",pieces:{q:"Dame",r:"Turm",b:"L\xE4ufer",n:"Springer"},promoteTo:"Umwandeln in"},en:{choosePromotion:"Choose promotion piece",promotionDialogTitle:"Pawn promotion",pieces:{q:"Queen",r:"Rook",b:"Bishop",n:"Knight"},promoteTo:"Promote to"}},R={pieceSelected:"pieceSelected",canceled:"canceled"},B=class extends S{constructor(e,t={}){super(e),this.props={language:navigator.language.substring(0,2).toLowerCase()},Object.assign(this.props,t),this.props.language!=="de"&&this.props.language!=="en"&&(this.props.language="en"),this.t=ce[this.props.language],this.pieceOrder=["q","r","b","n"],this.focusedIndex=0,this.previouslyFocusedElement=null,this.registerExtensionPoint(l.afterRedrawBoard,this.extensionPointRedrawBoard.bind(this)),this.registerExtensionPoint(l.destroy,this.destroy.bind(this)),e.showPromotionDialog=this.showPromotionDialog.bind(this),e.isPromotionDialogShown=this.isPromotionDialogShown.bind(this),this.promotionDialogGroup=h.addElement(e.view.interactiveTopLayer,"g",{class:"promotion-dialog-group",role:"dialog","aria-modal":"true","aria-label":this.t.choosePromotion}),this.liveRegion=document.createElement("div"),this.liveRegion.setAttribute("aria-live","polite"),this.liveRegion.setAttribute("aria-atomic","true"),this.liveRegion.className="cm-chessboard-promotion-live-region visually-hidden",this.liveRegion.style.cssText="position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;",e.context.appendChild(this.liveRegion),this.state={displayState:m.hidden,callback:null,dialogParams:{square:null,color:null}},this.handleKeyDown=this.handleKeyDown.bind(this)}showPromotionDialog(e,t,s){this.previouslyFocusedElement=document.activeElement,this.focusedIndex=0,this.state.dialogParams.square=e,this.state.dialogParams.color=t,this.state.callback=s,this.setDisplayState(m.displayRequested),setTimeout(()=>{this.chessboard.view.positionsAnimationTask.then(()=>{this.setDisplayState(m.shown),this.announce(this.t.choosePromotion+": "+this.pieceOrder.map(i=>this.t.pieces[i]).join(", "))})})}isPromotionDialogShown(){return this.state.displayState===m.shown||this.state.displayState===m.displayRequested}extensionPointRedrawBoard(){this.redrawDialog()}drawPieceButton(e,t,s){let i=this.chessboard.view.squareWidth,r=this.chessboard.view.squareHeight,o=e.charAt(1),a=this.t.pieces[o],c=h.addElement(this.promotionDialogGroup,"g",{class:"promotion-dialog-button-group",role:"button",tabindex:s===0?"0":"-1","aria-label":a,"data-piece":e,"data-index":s});h.addElement(c,"rect",{x:t.x,y:t.y,width:i,height:r,class:"promotion-dialog-button","data-piece":e}),this.chessboard.view.drawPiece(c,e,t)}redrawDialog(){for(;this.promotionDialogGroup.firstChild;)this.promotionDialogGroup.removeChild(this.promotionDialogGroup.firstChild);if(this.state.displayState===m.shown){let e=this.chessboard.view.squareWidth,t=this.chessboard.view.squareHeight,s=this.chessboard.view.squareToPoint(this.state.dialogParams.square);s.x=s.x+e/2,s.y=s.y+t/2;let i=!1,r=parseInt(this.state.dialogParams.square.charAt(1),10);(this.chessboard.getOrientation()===v.white&&r<5||this.chessboard.getOrientation()===v.black&&r>=5)&&(i=!0);let o=i?-4*t:0,a=s.x+e>this.chessboard.view.width?-e:0;h.addElement(this.promotionDialogGroup,"rect",{x:s.x+a,y:s.y+o,width:e,height:t*4,class:"promotion-dialog"});let c=this.state.dialogParams;i?(this.drawPieceButton(k[c.color+"q"],{x:s.x+a,y:s.y-t},0),this.drawPieceButton(k[c.color+"r"],{x:s.x+a,y:s.y-t*2},1),this.drawPieceButton(k[c.color+"b"],{x:s.x+a,y:s.y-t*3},2),this.drawPieceButton(k[c.color+"n"],{x:s.x+a,y:s.y-t*4},3)):(this.drawPieceButton(k[c.color+"q"],{x:s.x+a,y:s.y},0),this.drawPieceButton(k[c.color+"r"],{x:s.x+a,y:s.y+t},1),this.drawPieceButton(k[c.color+"b"],{x:s.x+a,y:s.y+t*2},2),this.drawPieceButton(k[c.color+"n"],{x:s.x+a,y:s.y+t*3},3))}}promotionDialogOnClickPiece(e){if(e.button!==2){let t=e.target.dataset.piece;if(!t&&e.target.closest){let s=e.target.closest(".promotion-dialog-button-group");s&&(t=s.dataset.piece)}t?this.selectPiece(t):this.promotionDialogOnCancel(e)}}selectPiece(e){this.state.callback&&this.state.callback({type:R.pieceSelected,square:this.state.dialogParams.square,piece:e}),this.setDisplayState(m.hidden)}promotionDialogOnCancel(e){this.state.displayState===m.shown&&(e.preventDefault(),this.setDisplayState(m.hidden),this.state.callback&&this.state.callback({type:R.canceled}))}contextMenu(e){e.preventDefault(),this.setDisplayState(m.hidden),this.state.callback&&this.state.callback({type:R.canceled})}setDisplayState(e){this.state.displayState=e,e===m.shown?(this.clickDelegate=p.delegate(this.chessboard.view.svg,"pointerdown","*",this.promotionDialogOnClickPiece.bind(this)),this.contextMenuListener=this.contextMenu.bind(this),this.chessboard.view.svg.addEventListener("contextmenu",this.contextMenuListener),document.addEventListener("keydown",this.handleKeyDown)):e===m.hidden&&(this.clickDelegate.remove(),this.chessboard.view.svg.removeEventListener("contextmenu",this.contextMenuListener),document.removeEventListener("keydown",this.handleKeyDown),this.previouslyFocusedElement&&this.previouslyFocusedElement.focus&&this.previouslyFocusedElement.focus()),this.redrawDialog(),e===m.shown&&setTimeout(()=>{this.focusButton(0)},0)}handleKeyDown(e){if(this.state.displayState===m.shown)switch(e.key){case"ArrowDown":case"ArrowRight":e.preventDefault(),this.focusedIndex=(this.focusedIndex+1)%4,this.focusButton(this.focusedIndex);break;case"ArrowUp":case"ArrowLeft":e.preventDefault(),this.focusedIndex=(this.focusedIndex-1+4)%4,this.focusButton(this.focusedIndex);break;case"Enter":case" ":e.preventDefault();let t=this.promotionDialogGroup.querySelectorAll(".promotion-dialog-button-group");if(t[this.focusedIndex]){let s=t[this.focusedIndex].dataset.piece;this.selectPiece(s)}break;case"Escape":e.preventDefault(),this.setDisplayState(m.hidden),this.state.callback&&this.state.callback({type:R.canceled});break;case"Tab":e.preventDefault(),e.shiftKey?this.focusedIndex=(this.focusedIndex-1+4)%4:this.focusedIndex=(this.focusedIndex+1)%4,this.focusButton(this.focusedIndex);break}}focusButton(e){let t=this.promotionDialogGroup.querySelectorAll(".promotion-dialog-button-group");if(t.forEach((s,i)=>{s.setAttribute("tabindex",i===e?"0":"-1")}),t[e]){t[e].focus();let s=this.pieceOrder[e];this.announce(this.t.pieces[s])}}announce(e){this.liveRegion.textContent="",setTimeout(()=>{this.liveRegion.textContent=e},50)}destroy(){document.removeEventListener("keydown",this.handleKeyDown),this.liveRegion&&this.liveRegion.parentNode&&this.liveRegion.parentNode.removeChild(this.liveRegion)}};window.AnkiChess={Chessboard:D,MARKER_TYPE:E,Markers:L,Arrows:O,PromotionDialog:B};console.log("AnkiChess Bundle cargado. MARKER_TYPE disponible.");})();
